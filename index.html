<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전투 파티 매칭</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- 1. 헤더 (전체 너비 최상단 고정) -->
        <header>
            <div class="header-content">
                <div class="logo-area">
                    <a href="#" class="logo" onclick="location.reload(); return false;">
                        <i class="fa-solid fa-dragon"></i>
                        <h1>전투</h1>
                    </a>
                    <i class="fa-regular fa-circle-question" id="guideBtn"></i>
                </div>

                <div class="search-bar">
                    <input type="text" id="headerSearchInput" placeholder="캐릭터 닉네임 검색">
                    <button id="headerSearchBtn"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <div class="user-menu">
                <button id="loginBtn" class="btn-outline">로그인</button>
                <div id="userInfo" class="hidden" style="display: flex; align-items: center; gap: 10px;">
                    <span id="userNickname" style="font-weight: 700;"></span>
                    <button id="pointsOpenBtn" class="btn-outline" style="padding: 4px 10px; font-size: 0.8rem;">
                        <i class="fa-solid fa-coins"></i> <span id="pointsBalanceText">0pt</span>
                    </button>
                    <span id="adminBadge" class="hidden" style="padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; background: rgba(34, 197, 94, 0.14); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3);">관리자</span>
                    <span id="rootBadge" class="hidden" style="padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 900; background: rgba(251, 191, 36, 0.12); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.28);">ROOT</span>
                    <button id="adminToolsBtn" class="btn-outline hidden" style="padding: 4px 10px; font-size: 0.8rem;">
                        <i class="fa-solid fa-screwdriver-wrench"></i> 관리자 도구
                    </button>
                    <button id="adminVerifyBtn" class="btn-outline" style="padding: 4px 10px; font-size: 0.8rem;">어드민 인증</button>
                    <button id="logoutBtn" class="btn-outline" style="padding: 4px 10px; font-size: 0.8rem;">로그아웃</button>
                </div>
            </div>
        </header>

        <!-- 2. 메인 바디 (좌: 공지 / 우: 게시판) -->
        <div class="layout-body">
            <!-- 좌측 공지사항 사이드바 -->
            <aside class="notice-sidebar">
                <div class="section-header-area">
                    <h3 class="section-title"><i class="fa-solid fa-bullhorn"></i> 공지사항</h3>
                    <button id="writeNoticeBtn" class="btn-small btn-outline hidden" style="padding: 2px 6px; font-size: 0.75rem;">
                        <i class="fa-solid fa-plus"></i> 작성
                    </button>
                </div>
                <div id="noticeList" class="notice-list">
                    <div class="notice-empty">등록된 공지사항이 없습니다.</div>
                </div>
                <!-- 더보기 버튼 -->
                <button id="loadMoreNoticeBtn" class="btn-outline full-width hidden" style="margin-top: 8px; font-size: 0.8rem; padding: 6px;">
                    <i class="fa-solid fa-chevron-down"></i> 더보기
                </button>
            </aside>

            <!-- 우측 게시판 섹션 -->
            <main class="board-section">
                <!-- 게시판 탭 -->
                <div class="board-tabs">
                    <button class="tab-btn active" data-tab="all">
                        <i class="fa-solid fa-layer-group"></i> 전체
                        <span class="sub-text">(모든 모집/구직)</span>
                    </button>
                    <button class="tab-btn" data-tab="party">
                        <i class="fa-solid fa-users"></i> 파티원 구해요
                        <span class="sub-text">(파티원이 필요해요)</span>
                    </button>
                    <button class="tab-btn" data-tab="member">
                        <i class="fa-solid fa-user-plus"></i> 파티 구해요
                        <span class="sub-text">(파티에 들어가고 싶어요)</span>
                    </button>
                    <button class="tab-btn" data-tab="completed">
                        <i class="fa-solid fa-check-circle"></i> 매칭 완료
                        <span class="sub-text">(지난 파티 보기)</span>
                    </button>
                </div>

                <!-- 필터 및 글쓰기 버튼 -->
                <div class="board-actions">
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <div class="filter-group">
                            <select id="roleFilter">
                                <option value="all">모든 직업 보기</option>
                                <option value="tank">탱커 (수호성/검성)</option>
                                <option value="dps">딜러 (살성/궁성/마도성/정령성)</option>
                                <option value="healer">힐러 (치유성/호법성)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="categoryFilter">
                                <option value="all">모든 콘텐츠 보기</option>
                                <option value="정복">정복</option>
                                <option value="성역">성역</option>
                                <option value="초월">초월</option>
                                <option value="토벌전">토벌전</option>
                                <option value="PVE (닥사)">PVE (닥사)</option>
                                <option value="PVP">PVP</option>
                            </select>
                        </div>
                    </div>
                    <button id="writeBtn" class="btn-primary"><i class="fa-solid fa-pen"></i> 글쓰기</button>
                </div>

                <!-- 게시글 리스트 -->
                <div id="postList" class="post-grid">
                </div>
            </main>
        </div>

        <footer>
            <p>© 지켈 서버 근접</p>
            <p>© 2026 Aion2 전투 레기온 파티 매칭. unofficial fan site.</p>
            <p>GitHub Pages로 호스팅되어 24시간 무료로 운영됩니다.</p>
        </footer>
    </div>

    <!-- 로그인/회원가입 모달 -->
    <div id="authModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="authModalTitle">로그인</h3>
                <button class="close-btn auth-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-tools-tabs" style="margin-bottom: 12px;">
                    <button id="authTabLogin" class="admin-tab-btn active" type="button"><i class="fa-solid fa-right-to-bracket"></i> 로그인</button>
                    <button id="authTabSignup" class="admin-tab-btn" type="button"><i class="fa-solid fa-user-plus"></i> 회원가입</button>
                </div>

                <p id="authHelpText" style="margin-bottom: 15px; color: var(--text-sub); font-size: 0.9rem; line-height: 1.6;">
                    이메일/비밀번호로 로그인합니다.
                </p>

                <form id="authForm">
                    <div class="form-group">
                        <label>아이디</label>
                        <input type="text" id="authLoginId" required placeholder="예: sexynamjun1004" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>비밀번호</label>
                        <input type="password" id="authPassword" required placeholder="비밀번호 (6자 이상)" autocomplete="current-password">
                    </div>

                    <div id="authPasswordConfirmGroup" class="form-group hidden">
                        <label>비밀번호 확인</label>
                        <input type="password" id="authPasswordConfirm" placeholder="비밀번호 확인" autocomplete="new-password">
                    </div>

                    <div id="authNicknameGroup" class="form-group hidden">
                        <label>닉네임 (회원가입 시 1회 설정, 이후 변경 불가)</label>
                        <input type="text" id="authNickname" placeholder="사이트에서 표시될 닉네임" autocomplete="nickname">
                        <p style="margin-top: 6px; color: var(--warning); font-size: 0.85rem;">
                            * 닉네임은 회원가입 후 변경할 수 없습니다.
                        </p>
                        <p style="margin-top: 6px; color: var(--text-muted); font-size: 0.85rem; line-height: 1.55;">
                            * 포인트 기능은 <b>관리자 승인</b> 후 사용할 수 있습니다. (승인 전: 출석/뽑기/랭킹/원장 이용 불가)
                        </p>
                    </div>

                    <div class="form-group" style="margin-top: 10px; margin-bottom: 14px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color: var(--text-sub); font-size: 0.9rem;">
                            <input type="checkbox" id="authRememberMe" checked style="width:auto; transform: translateY(1px);">
                            로그인 상태 유지
                        </label>
                        <p style="margin-top: 6px; color: var(--text-muted); font-size: 0.85rem; line-height: 1.55;">
                            * 공용 PC에서는 체크 해제 권장
                        </p>
                    </div>

                    <button type="submit" id="authSubmitBtn" class="btn-primary full-width">로그인</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 글쓰기 모달 -->
    <div id="writeModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">파티 모집글 작성</h3>
                <button class="close-btn write-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="postForm">
                    <!-- 공지사항용 안내 메시지 -->
                    <div id="noticeMessage" class="form-group hidden" style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #f59e0b; text-align: center;">
                        <p style="color: #f59e0b; font-weight: 700; margin: 0;"><i class="fa-solid fa-bullhorn"></i> 공지사항 작성 중</p>
                    </div>

                    <!-- 콘텐츠 선택 -->
                    <div class="form-group">
                        <label>제목</label>
                        <input type="text" id="postTitle" required placeholder="예: 초월 3단계 가실분">
                    </div>

                    <div class="form-group">
                        <label>내용</label>
                        <textarea id="postContent" required placeholder="출발 시간 혹은 기타 특이 사항 작성"></textarea>
                    </div>
                    
                    <div class="form-group" id="guestNameGroup">
                        <label>게임 닉네임 (비회원 작성)</label>
                        <input type="text" id="postGuestName" placeholder="예: 캐릭터닉네임">
                    </div>

                    <div class="form-group" id="guestPasswordGroup">
                        <label>게시글 비밀번호 (비회원 수정/삭제용)</label>
                        <input type="password" id="postGuestPassword" placeholder="4자리 이상" minlength="4">
                        <p style="font-size: 0.8rem; color: var(--text-sub); margin-top: 5px;">* 비회원 작성 시에만 필요합니다.</p>
                    </div>

                    <button type="submit" id="submitPostBtn" class="btn-primary full-width">등록하기</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 파티 관리 모달 -->
    <div id="manageModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>내 파티 관리</h3>
                <button class="close-btn manage-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="managePostInfo" style="margin-bottom: 20px;">
                </div>

                <div class="form-group">
                    <label>상태 변경</label>
                    <div class="manage-btn-group">
                        <button id="btnStatusRecruiting" class="btn-success">모집중</button>
                        <button id="btnStatusFull" class="btn-danger">모집완료</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>파티원 관리</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <input type="text" id="newMemberName" placeholder="파티원 닉네임" style="flex: 2;">
                        <select id="newMemberClass" style="flex: 1.5;">
                            <option value="검성">검성</option>
                            <option value="수호성">수호성</option>
                            <option value="살성">살성</option>
                            <option value="궁성">궁성</option>
                            <option value="마도성">마도성</option>
                            <option value="정령성">정령성</option>
                            <option value="치유성">치유성</option>
                            <option value="호법성">호법성</option>
                        </select>
                        <button id="addMemberBtn" class="btn-small">추가</button>
                    </div>
                    <div id="partyMemberList" class="member-list">
                        <!-- 멤버 리스트 -->
                    </div>
                </div>

                <button id="deletePostBtn" class="btn-danger full-width" style="margin-top: 20px; border-color: var(--border); color: var(--text-sub);">게시글 삭제</button>
            </div>
        </div>
    </div>

    <!-- 상세 보기 모달 -->
    <div id="detailModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>게시글 상세 정보</h3>
                <button class="close-btn detail-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-header">
                    <div style="flex:1;">
                        <div id="detailCategoryBadge" style="margin-bottom: 8px; display: inline-block;"></div>
                        <div id="detailRoles" style="margin-bottom:8px; display: inline-block;"></div>
                        <h4 id="detailTitle" class="detail-title">제목</h4>
                        <div class="detail-meta">
                            <span id="detailAuthor">작성자</span> | 
                            <span id="detailTime">시간</span>
                        </div>
                    </div>
                </div>
                
                <div id="detailContent" class="detail-content">내용</div>
                
                <!-- 파티 관련 정보 영역 -->
                <div id="detailPartySection">
                    <div class="form-group">
                        <label>작성자 정보</label>
                        <div id="detailAuthorProfile" class="party-member-card" style="cursor: pointer; display: flex; align-items: center; gap: 15px; text-align: left; background: var(--bg-hover);">
                            <img id="detailAuthorAvatar" src="" class="pm-avatar" style="margin-bottom: 0;">
                            <div>
                                <div id="detailAuthorName" class="pm-name" style="font-size: 1.1rem;">닉네임</div>
                                <div class="pm-class"><span id="detailAuthorClass">직업</span></div>
                                <div class="pm-dps" style="margin-top: 4px;">아이템 Lv <span id="detailAuthorItemLevel">0</span></div>
                            </div>
                        </div>
                        <p style="font-size: 0.8rem; color: #a78bfa; margin-top: 8px; text-align: center;">
                            <i class="fa-solid fa-arrow-pointer"></i> 카드를 클릭하면 상세 페이지로 이동합니다.
                        </p>
                    </div>
                    
                    <!-- 파티원 목록 영역 -->
                    <div class="form-group">
                         <div id="detailPartyListContainer"></div>
                    </div>
                </div>
                
                <div style="margin-top:20px; text-align:center;">
                    <a id="detailLink" href="#" target="_blank" class="btn-primary full-width hidden" style="display:inline-block; text-decoration:none;">오픈채팅/디스코드 참여</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 캐릭터 검색 결과 모달 -->
    <div id="searchResultModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>캐릭터 검색 결과</h3>
                <button class="close-btn search-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="searchResultContent">
                    <!-- JS로 채워짐 -->
                </div>
                <div style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px;">
                     <button id="openCalculatorBtn" class="btn-success full-width">
                        <i class="fa-solid fa-calculator"></i> 전투력(DPS) 시뮬레이터
                     </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DPS 시뮬레이터 모달 -->
    <div id="dpsCalculatorModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>전투력(DPS) 시뮬레이터</h3>
                <button class="close-btn calc-close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 0.85rem; color: var(--text-sub); margin-bottom: 20px; background: rgba(30,30,40,0.5); padding: 10px; border-radius: 8px;">
                    <i class="fa-solid fa-circle-info"></i> 캐릭터 검색 후 스탯을 불러오거나 직접 입력하여 예상 전투력을 계산해보세요.<br>
                    (아툴 공식 기준 계산식이며, 실제 인게임과는 차이가 있을 수 있습니다.)
                </p>
                <button id="calcAtulBtn" class="btn-outline full-width" style="margin-top:-10px; margin-bottom: 20px;">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> 아툴 바로가기
                </button>

                <div class="calculator-grid">
                    <!-- 기본 스탯 -->
                    <div class="calc-section">
                        <h4>기본 스탯</h4>
                        <div class="form-group-row">
                            <label>공격력</label>
                            <input type="number" id="calcAttackPower" placeholder="0">
                        </div>
                        <div class="form-group-row">
                            <label>무기 최소공격력</label>
                            <input type="number" id="calcWeaponMin" placeholder="0">
                        </div>
                        <div class="form-group-row">
                            <label>무기 최대공격력</label>
                            <input type="number" id="calcWeaponMax" placeholder="0">
                        </div>
                        <div class="form-group-row">
                            <label style="display:flex; align-items:center; gap:6px;">
                                치명타 수치
                                <span class="tooltip-icon" data-tooltip="아툴 내에 치명타 i 아이콘을 눌러 % 수치가 아닌 합계 수치를 입력해 주세요.">
                                    <i class="fa-solid fa-circle-info"></i>
                                </span>
                            </label>
                            <input type="number" id="calcCritStat" placeholder="0">
                        </div>
                    </div>

                    <!-- 퍼센트 스탯 -->
                    <div class="calc-section">
                        <h4>증폭/추가 (%)</h4>
                        <div class="form-group-row">
                            <label>전투 속도</label>
                            <input type="number" id="calcCombatSpeed" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>무기 피해 증폭</label>
                            <input type="number" id="calcWeaponDamageAmp" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>피해 증폭 (통합)</label>
                            <input type="number" id="calcDamageAmp" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>치명타 피해 증폭</label>
                            <input type="number" id="calcCritDamageAmp" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>스킬 피해 증폭</label>
                            <input type="number" id="calcSkillDamage" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>재사용 대기시간 감소</label>
                            <input type="number" id="calcCooldownReduction" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>강타 적중</label>
                            <input type="number" id="calcStunHit" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>완벽</label>
                            <input type="number" id="calcPerfect" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group-row">
                            <label>다단 히트 적중</label>
                            <input type="number" id="calcMultiHit" placeholder="0" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="result-area" style="margin-top: 20px; padding: 20px; background: var(--bg-hover); border-radius: 12px; text-align: center; border: 1px solid var(--primary);">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">예상 아툴 전투력</div>
                    <div id="calcResultScore" style="font-size: 2rem; font-weight: 700; color: var(--primary-light); font-family: 'Cafe24Ssurround';">0</div>
                    <div id="calcDiff" style="font-size: 0.9rem; color: var(--danger); font-weight: 700; height: 20px;"></div>
                    
                    <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); text-align:left;">
                        <div class="form-group-row" style="margin-bottom: 10px;">
                            <label style="min-width: 110px;">목표 전투력</label>
                            <input type="number" id="calcTargetScore" placeholder="예: 35000" style="flex:1;">
                        </div>
                        <button id="doRecommendBtn" class="btn-success full-width" style="margin-top: 6px;">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> 목표 달성 추천
                        </button>
                        <div id="calcRecommendOutput" style="margin-top: 12px; font-size: 0.9rem; color: var(--text-sub); line-height: 1.55; white-space: pre-wrap;"></div>
                    </div>
                </div>

                <button id="doCalculateBtn" class="btn-primary full-width" style="margin-top: 20px;">계산하기</button>
            </div>
        </div>
    </div>

    <!-- 가이드 모달 -->
    <div id="guideModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>웹사이트 사용 가이드</h3>
                <button class="close-btn guide-close">&times;</button>
            </div>
            <div class="modal-body" style="line-height: 1.8; color: var(--text-sub);">
                <p><strong>1. 로그인 (관리자 전용)</strong></p>
                <p>로그인은 관리자 전용 기능입니다. 일반 유저는 로그인하지 않아도 게시글을 작성할 수 있습니다.</p>
                
                <p style="margin-top: 15px;"><strong>2. 글쓰기 & 관리</strong></p>
                <p>파티 모집 또는 구직 글은 로그인 없이도 작성할 수 있습니다. 비회원 작성 시 닉네임과 비밀번호(4자리 이상)를 입력하면 수정/삭제가 가능합니다.</p>
                
                <p style="margin-top: 15px;"><strong>3. 디스코드 알림 & 자동 삭제</strong></p>
                <p>글이 등록되면 디스코드에 알림이 갑니다. <strong>등록 후 3시간</strong>이 지나면 게시글과 디스코드 알림이 <strong>자동으로 삭제</strong>됩니다.</p>
            </div>
        </div>
    </div>

    <!-- 토스트 메시지 컨테이너 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- 관리자 도구 모달 (어드민 전용 UI) -->
    <div id="adminToolsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fa-solid fa-screwdriver-wrench"></i> 관리자 도구</h3>
                <button class="close-btn admin-tools-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-tools-tabs">
                    <button class="admin-tab-btn active" data-admin-tab="audit"><i class="fa-solid fa-clipboard-list"></i> 로그</button>
                    <button class="admin-tab-btn" data-admin-tab="backup"><i class="fa-solid fa-database"></i> 백업/복구</button>
                </div>

                <div id="adminTabAudit" class="admin-tab-panel">
                    <div class="admin-tools-row">
                        <select id="auditTypeFilter">
                            <option value="all">전체 이벤트</option>
                            <option value="hard_delete_detected">hard_delete_detected</option>
                            <option value="realtime_listener_error">realtime_listener_error</option>
                            <option value="discord_delete_error">discord_delete_error</option>
                            <option value="expire_soft_delete_error">expire_soft_delete_error</option>
                        </select>
                        <input id="auditSearch" type="text" placeholder="postId/작성자/제목/사유 검색">
                        <button id="auditReloadBtn" class="btn-outline"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                    </div>
                    <div id="auditList" class="admin-audit-list">
                        <div style="color: var(--text-sub); padding: 12px;">로그를 불러오는 중...</div>
                    </div>
                    <div style="margin-top:8px; color: var(--text-muted); font-size:0.85rem;">
                        - 시간은 KST로 표시됩니다. (상세 원본은 ISO도 함께 표시)<br>
                        - 이 화면은 “UI상 관리자 전용”이며, 보안 강제는 Firestore Rules로 해야 합니다.
                    </div>
                </div>

                <div id="adminTabBackup" class="admin-tab-panel hidden">
                    <div class="admin-tools-row" style="align-items: stretch;">
                        <button id="exportPostsBtn" class="btn-success"><i class="fa-solid fa-file-export"></i> 게시글+공지 내보내기</button>
                        <button id="exportNoticesBtn" class="btn-outline"><i class="fa-solid fa-bullhorn"></i> 공지만 내보내기</button>
                        <button id="exportPostsIncludeDeletedBtn" class="btn-outline"><i class="fa-solid fa-eye-slash"></i> (삭제포함) 전체 내보내기</button>
                    </div>

                    <div style="margin-top:16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <div style="font-weight: 800; color: var(--text-main);">
                                <i class="fa-solid fa-trash-arrow-up"></i> 삭제된 글 복구 (soft delete)
                            </div>
                            <div class="admin-tools-row" style="margin:0;">
                                <input id="restoreSearch" type="text" placeholder="제목/작성자/postId 검색" style="min-width: 240px;">
                                <button id="restoreReloadBtn" class="btn-outline"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                            </div>
                        </div>
                        <div id="restoreList" class="admin-audit-list" style="margin-top:10px;">
                            <div style="color: var(--text-sub); padding: 12px;">삭제된 글이 없습니다.</div>
                        </div>
                        <div style="margin-top:8px; color: var(--text-muted); font-size:0.85rem;">
                            - 여기서 복구되는 것은 “soft delete( deletedAt 찍힌 글 )”입니다.<br>
                            - 복구 시 `deletedAt/삭제사유` 필드를 제거하고, 게시글은 상태를 `recruiting`으로 되돌립니다. (디스코드 알림은 자동 복구되지 않습니다.)
                        </div>
                    </div>

                    <div style="margin-top:14px; color: var(--text-sub);">
                        복구(JSON)는 아래에 붙여넣고 “가져오기”를 누르세요. (배열 형태)
                    </div>
                    <textarea id="importJsonText" class="admin-json-textarea" placeholder='예: [{"id":"...","type":"party",...}]'></textarea>
                    <div class="admin-tools-row" style="margin-top:10px;">
                        <select id="importMode">
                            <option value="upsert">업서트(동일 id면 업데이트, 없으면 생성)</option>
                            <option value="create_only">생성만(동일 id면 건너뜀)</option>
                        </select>
                        <button id="importBtn" class="btn-primary"><i class="fa-solid fa-file-import"></i> 가져오기</button>
                        <button id="clearImportBtn" class="btn-outline">비우기</button>
                    </div>
                    <div style="margin-top:8px; color: var(--text-muted); font-size:0.85rem;">
                        - delete가 막혀 있으면 “하드 삭제 복구”는 새 문서로만 가능합니다.<br>
                        - 삭제된 글을 다시 보이게 하려면(soft delete) `deletedAt`을 제거하는 업데이트가 필요합니다.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 포인트/뽑기 모달 -->
    <div id="pointsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <h3 style="margin:0;"><i class="fa-solid fa-coins"></i> 포인트</h3>
                    <button id="pointsHowtoBtn" class="btn-outline btn-small" type="button" style="padding: 6px 10px; font-size: 0.85rem;">
                        <i class="fa-solid fa-circle-info"></i> 포인트 획득 방법
                    </button>
                </div>
                <button class="close-btn points-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pointsHowtoPanel" class="points-howto hidden">
                    <div class="points-howto-title">포인트 획득 방법 (KST 기준)</div>
                    <div class="points-howto-grid">
                        <div class="points-howto-card">
                            <div class="t">출석 체크</div>
                            <ul class="points-howto-list">
                                <li>1회 <b>+10pt</b></li>
                                <li>일일 최대 <b>1회</b> / 주간 최대 <b>7회</b></li>
                            </ul>
                        </div>
                        <div class="points-howto-card">
                            <div class="t">게시글 작성</div>
                            <ul class="points-howto-list">
                                <li>파티원 구해요: 1회 <b>+10pt</b> (일 3 / 주 21)</li>
                                <li>파티 구해요: 1회 <b>+10pt</b> (일 3 / 주 21)</li>
                            </ul>
                        </div>
                        <div class="points-howto-card">
                            <div class="t">연속 출석 보너스</div>
                            <ul class="points-howto-list">
                                <li>3일 연속: <b>+10pt</b></li>
                                <li>7일 연속: <b>+30pt</b></li>
                                <li>14일 연속: <b>+70pt</b></li>
                            </ul>
                            <div class="points-howto-sub">연속이 끊기면 보너스 진행이 초기화될 수 있습니다.</div>
                        </div>
                        <div class="points-howto-card">
                            <div class="t">관리자 지급/회수</div>
                            <ul class="points-howto-list">
                                <li>관리자가 사유를 남기고 지급/회수할 수 있습니다.</li>
                                <li>내역은 <b>포인트 로그</b>에서 공개됩니다.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="points-howto-foot">
                        * 포인트는 “원장(기록)” 기반으로 관리되며, 잔액/누적은 원장으로부터 계산됩니다.
                    </div>
                </div>

                <div class="points-tabs">
                    <button class="points-tab-btn active" data-points-tab="me"><i class="fa-solid fa-user"></i> 내 포인트</button>
                    <button class="points-tab-btn" data-points-tab="gacha"><i class="fa-solid fa-dice"></i> 뽑기</button>
                    <button class="points-tab-btn" data-points-tab="ranking"><i class="fa-solid fa-ranking-star"></i> 랭킹</button>
                    <button class="points-tab-btn" data-points-tab="publicLog"><i class="fa-solid fa-scale-balanced"></i> 포인트 로그</button>
                    <button id="pointsAdminTabBtn" class="points-tab-btn hidden" data-points-tab="admin"><i class="fa-solid fa-screwdriver-wrench"></i> 관리자</button>
                    <button id="pointsEventTabBtn" class="points-tab-btn hidden" data-points-tab="event"><i class="fa-solid fa-star"></i> 이벤트</button>
                </div>

                <div id="pointsTabMe" class="points-tab-panel">
                    <div class="points-grid">
                        <div class="points-card">
                            <div class="points-card-title">요약</div>
                            <div class="points-kv">
                                <div><span class="k">현재 보유</span><span id="pointsMeBalance" class="v">0</span></div>
                                <div><span class="k">누적 획득</span><span id="pointsMeLifetime" class="v">0</span></div>
                            </div>
                            <div class="points-actions">
                                <button id="attendanceBtn" class="btn-success"><i class="fa-solid fa-calendar-check"></i> 출석 체크 (+10)</button>
                                <button id="pointsRefreshBtn" class="btn-outline"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                            </div>
                            <div id="streakBox" class="streak-box">
                                <div class="streak-top">
                                    <div class="streak-title">연속 출석</div>
                                    <div id="streakToday" class="streak-today">오늘: -</div>
                                </div>
                                <div class="streak-main">
                                    <div><span class="k">현재</span> <span id="streakDays" class="v">0</span>일</div>
                                    <div><span class="k">다음 보상</span> <span id="streakNext" class="v">-</span></div>
                                </div>
                                <div class="streak-progress">
                                    <div class="bar"><div id="streakBar" class="bar-fill" style="width:0%"></div></div>
                                    <div id="streakHint" class="hint">-</div>
                                </div>
                            </div>
                            <div class="points-hint">
                                - 일/주 제한은 KST 기준으로 계산됩니다.<br>
                                - 포인트는 원장(트랜잭션) 기반이며, 요약값은 표시/랭킹용 캐시입니다.
                            </div>
                        </div>

                        <div class="points-card">
                            <div class="points-card-title">최근 원장</div>
                            <div id="pointsLedgerList" class="points-list">
                                <div class="points-empty">로그인을 하면 원장이 표시됩니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pointsTabGacha" class="points-tab-panel hidden">
                    <div class="points-card">
                        <div class="points-card-title">뽑기</div>
                        <div class="points-kv">
                            <div><span class="k">1회 비용</span><span id="gachaCostText" class="v">100pt</span></div>
                            <div><span class="k">내 누적 뽑기</span><span id="gachaTotalDraws" class="v">0</span></div>
                            <div><span class="k">이벤트</span><span id="gachaEventBadge" class="v">-</span></div>
                            <div><span class="k">회차</span><span id="gachaRoundText" class="v">-</span></div>
                            <div><span class="k">당첨 현황</span><span id="gachaWinnersText" class="v">-</span></div>
                        </div>
                        <div class="points-actions">
                            <button id="gachaDrawBtn" class="btn-primary"><i class="fa-solid fa-dice"></i> 1회 뽑기</button>
                            <button id="gachaRefreshBtn" class="btn-outline"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                        </div>
                        <div id="gachaRollStage" class="gacha-roll hidden">
                            <div class="gacha-roll-inner">
                                <div class="gacha-roll-title">뽑기 진행중...</div>
                                <div id="gachaRollText" class="gacha-roll-text">행운을 불러오는 중</div>
                                <div class="gacha-roll-bar">
                                    <div class="gacha-roll-bar-fill"></div>
                                </div>
                            </div>
                        </div>
                        <div id="gachaResult" class="points-result-box hidden"></div>

                        <div class="points-card" style="margin-top: 14px;">
                            <div class="points-card-title">이번 회차 당첨자</div>
                            <div id="gachaWinnersList" class="points-list">
                                <div class="points-empty">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pointsTabEvent" class="points-tab-panel hidden">
                    <div class="points-card">
                        <div class="points-card-title">이벤트 안내</div>
                        <div id="eventPublicBox" class="points-result-box">-</div>
                    </div>

                    <div id="rootGachaControlCard" class="points-card hidden" style="margin-top: 14px;">
                        <div class="points-card-title">ROOT 전용: 뽑기 운영(활성/회차/당첨인원)</div>
                        <div class="points-admin-form">
                            <div class="form-group">
                                <label>뽑기 활성화</label>
                                <select id="gachaEnabled">
                                    <option value="false">비활성</option>
                                    <option value="true">활성</option>
                                </select>
                                <p style="margin-top:6px; color: var(--text-muted); font-size: 0.85rem;">
                                    * 비활성 상태에서는 뽑기가 절대 진행되지 않습니다.
                                </p>
                            </div>
                            <div class="form-group">
                                <label>회차</label>
                                <input type="number" id="gachaRoundNo" step="1" min="1" placeholder="예: 1">
                            </div>
                            <div class="form-group">
                                <label>당첨 인원</label>
                                <input type="number" id="gachaMaxWinners" step="1" min="1" placeholder="예: 3">
                                <p style="margin-top:6px; color: var(--text-muted); font-size: 0.85rem;">
                                    * 당첨 인원이 채워지면 해당 회차는 자동 종료됩니다.
                                </p>
                            </div>
                            <button id="saveGachaControlBtn" class="btn-success full-width"><i class="fa-solid fa-floppy-disk"></i> 뽑기 운영 저장</button>
                            <div id="gachaControlStatusText" class="points-hint" style="margin-top:10px;">-</div>
                        </div>
                    </div>

                    <div id="rootEventCard" class="points-card hidden" style="margin-top: 14px;">
                        <div class="points-card-title">ROOT 전용: 확률/비용 이벤트 설정 (KST)</div>
                        <div class="points-admin-form">
                            <div class="form-group">
                                <label>이벤트 활성화</label>
                                <select id="gachaEventEnabled">
                                    <option value="false">비활성</option>
                                    <option value="true">활성</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>시작 (KST)</label>
                                <input type="datetime-local" id="gachaEventStartKst">
                            </div>
                            <div class="form-group">
                                <label>종료 (KST)</label>
                                <input type="datetime-local" id="gachaEventEndKst">
                            </div>
                            <div class="form-group">
                                <label>확률 배수</label>
                                <input type="number" id="gachaEventMultiplier" step="0.1" min="0" placeholder="예: 2">
                            </div>
                            <div class="form-group">
                                <label>뽑기 1회 비용(선택)</label>
                                <input type="number" id="gachaEventCostOverride" step="1" min="0" placeholder="예: 50 (비워두면 100 유지)">
                                <p style="margin-top:6px; color: var(--text-muted); font-size: 0.85rem;">
                                    * 예: 100 → 50로 보이게 표시되고 실제 차감도 50으로 적용됩니다.
                                </p>
                            </div>
                            <div class="form-group">
                                <label>유저에게 보여줄 문구</label>
                                <textarea id="gachaEventMessage" placeholder="예: 신년 이벤트 진행중! 뽑기 확률 UP + 비용 할인!" style="min-height: 100px;"></textarea>
                            </div>
                            <button id="saveGachaEventBtn" class="btn-success full-width"><i class="fa-solid fa-wand-magic-sparkles"></i> 이벤트 저장</button>
                            <div id="gachaEventStatusText" class="points-hint" style="margin-top:10px;">-</div>
                        </div>
                    </div>

                    <div id="rootBulkPointsCard" class="points-card hidden" style="margin-top: 14px;">
                        <div class="points-card-title">ROOT 전용: 전체 유저 포인트 일괄 지급/회수</div>
                        <div class="points-admin-form">
                            <div class="form-group">
                                <label>지급/회수</label>
                                <select id="rootBulkMode">
                                    <option value="grant">지급 (+)</option>
                                    <option value="withdraw">회수 (-)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>포인트</label>
                                <input type="number" id="rootBulkAmount" step="1" min="1" placeholder="예: 100">
                            </div>
                            <div class="form-group">
                                <label>사유(필수)</label>
                                <input type="text" id="rootBulkReason" placeholder="예: 이벤트 보상 일괄 지급">
                            </div>
                            <div class="form-group">
                                <label>대상</label>
                                <select id="rootBulkTarget">
                                    <option value="all">모든 계정(user_profiles)</option>
                                    <option value="approved_only">포인트 승인된 계정만</option>
                                </select>
                            </div>
                            <button id="rootBulkApplyBtn" class="btn-danger full-width"><i class="fa-solid fa-bolt"></i> 일괄 적용</button>
                            <div id="rootBulkStatusText" class="points-hint" style="margin-top:10px;">-</div>
                        </div>
                    </div>
                </div>

                <div id="pointsTabRanking" class="points-tab-panel hidden">
                    <div class="points-card">
                        <div class="points-card-title">누적 획득 포인트 랭킹</div>
                        <div id="pointsRankingList" class="points-list">
                            <div class="points-empty">불러오는 중...</div>
                        </div>
                    </div>
                </div>

                <div id="pointsTabPublicLog" class="points-tab-panel hidden">
                    <div class="points-card">
                        <div class="points-card-title">관리자 지급/회수 공개 로그</div>
                        <div id="pointsPublicAdminLogList" class="points-list">
                            <div class="points-empty">불러오는 중...</div>
                        </div>
                    </div>
                </div>

                <div id="pointsTabAdmin" class="points-tab-panel hidden">
                    <div class="points-card">
                        <div class="points-card-title">관리자 포인트 지급/회수</div>
                        <div class="points-admin-form">
                            <div class="form-group">
                                <label>대상 유저 닉네임</label>
                                <input type="text" id="adminAdjustTarget" placeholder="예: 캐릭터닉네임">
                            </div>
                            <div class="form-group">
                                <label>포인트 변경(+) 지급 / (-) 회수</label>
                                <input type="number" id="adminAdjustDelta" placeholder="예: 100 또는 -100">
                            </div>
                            <div class="form-group">
                                <label>사유(필수)</label>
                                <input type="text" id="adminAdjustReason" placeholder="사유를 입력하세요">
                            </div>
                            <button id="adminAdjustSubmitBtn" class="btn-danger full-width"><i class="fa-solid fa-gavel"></i> 적용</button>
                            <div class="points-hint" style="margin-top:10px;">
                                - 이 기능은 UI상 관리자 전용이며, 실제 보안 강제는 서버/Firestore Rules가 필요합니다.
                            </div>
                        </div>
                    </div>

                    <div class="points-card" style="margin-top: 14px;">
                        <div class="points-card-title">포인트 승인 대기</div>
                        <div class="points-actions" style="margin-top:0;">
                            <button id="pendingApprovalsReloadBtn" class="btn-outline"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                        </div>
                        <div id="pendingApprovalsList" class="points-list" style="margin-top:10px;">
                            <div class="points-empty">관리자만 볼 수 있습니다.</div>
                        </div>
                        <div class="points-hint">
                            - 회원가입 직후에는 포인트 기능이 잠겨 있으며, 여기서 승인하면 출석/뽑기/원장/랭킹 이용이 가능해집니다.
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- Firebase SDK (Version 9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    
    <script src="script.min.js?v=20260116-7"></script>
</body>

</html>
