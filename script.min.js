const API_BASE_URL="https://api.aon2.info/api/v1/aion2",PROXY_URL="",APP_VERSION="2026-01-09.1",POST_WEBHOOK_SECRET="aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTQ1NjU1OTI1NzA3ODk4ODgyMS81VDczT1VxWUxnZzFEYUs1Skk3M0R2OFpfYzdNVlBiajZXUkE0c3VyQ0paQ1ZXSW96T1Voel9rWDBhVEdiSkx3WkJLRg==",LOG_WEBHOOK_SECRET="aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTQ1ODY4MjU4OTQ1MDg2NjY4OS9QazduSFUtRmlubTJGQmo1cTk3UF85YU5hNzhZU3ZTOGRaY2M4OGdQaVFTZ285RXhqOXU4aDQ1UlNpQ291QTJiUUVVRQ==",DISCORD_POST_WEBHOOK_URL="https://discord.com/api/webhooks/1456559257078988821/5T73OUqYLgg1DaK5JI73Dv8Z_c7MVPbj6WRA4surCJZCVWIozOUhz_kX0aTGbJLwZBKF",DISCORD_LOG_WEBHOOK_URL=atob(LOG_WEBHOOK_SECRET),DISCORD_GACHA_WIN_WEBHOOK_URL="https://discord.com/api/webhooks/1461253087606866022/u1PYYFXAEEaNl9z16ENXMerFVSd2w_GjWSZtVgYCNTngu0vcZLYrk_kskSWYkX-857wN",GACHA_WIN_WEBHOOK_STORAGE_KEY="rudra_gacha_win_webhook_url";function getGachaWinWebhookUrl(){try{if(DISCORD_GACHA_WIN_WEBHOOK_URL)return DISCORD_GACHA_WIN_WEBHOOK_URL;const e=String(localStorage.getItem("rudra_gacha_win_webhook_url")||"").trim();if(!e)return"";if(e.startsWith("https://")||e.startsWith("http://"))return e;const t=atob(e);return t.startsWith("https://")||t.startsWith("http://")?t:""}catch{return""}}const DISCORD_ADMIN={clientId:"1440197568847151214",guildId:"1427195769793937428",roleId:"1427200649971372052",scopes:["identify","guilds.members.read"],verifyEndpoint:"https://frosty-tooth-60e.k47m31s.workers.dev/"},CONSTANTS={DEFAULT_EXPIRATION_MS:108e5,NOTICE_LIMIT:3},POINTS={COST_GACHA:100,BASE_RATE:5e-4,EARN:{ATTENDANCE:10,POST:10,STREAK_3:10,STREAK_7:30,STREAK_14:70},LIMITS:{ATTENDANCE:{daily:1,weekly:7},POST_PARTY:{daily:3,weekly:21},POST_MEMBER:{daily:3,weekly:21}}},FIRESTORE_POINTS={summary:"user_point_summary",state:"point_state",counters:"point_counters",ledgerUsers:"point_ledger_users",publicAdminLog:"public_point_admin_log",gachaDrawsUsers:"gacha_draws_users",userProfiles:"user_profiles",nicknameIndex:"nickname_index",admins:"admins",roots:"roots",gachaEvent:"gacha_event",gachaRounds:"gacha_rounds"};function normalizeNickname(e){return String(e||"").trim()}function nicknameKey(e){const t=normalizeNickname(e).toLowerCase();return t?t.replaceAll("/","_"):null}function getKstDateKeyFromNow(){return new Date(Date.now()+324e5).toISOString().slice(0,10)}function getIsoWeekKeyFromKstNow(){const e=new Date(Date.now()+324e5),t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);const a=new Date(Date.UTC(t.getUTCFullYear(),0,1)),s=Math.ceil(((t-a)/864e5+1)/7);return`${t.getUTCFullYear()}-W${String(s).padStart(2,"0")}`}function getPointsRefsForUser(e){return{summaryRef:db.collection(FIRESTORE_POINTS.summary).doc(e),stateRef:db.collection(FIRESTORE_POINTS.state).doc(e),ledgerCol:db.collection(FIRESTORE_POINTS.ledgerUsers).doc(e).collection("items"),drawsCol:db.collection(FIRESTORE_POINTS.gachaDrawsUsers).doc(e).collection("items")}}async function ensurePointDocsForCurrentUser(){if(!db)return;if(!currentUser?.uid)return;const e=currentUser.uid,{summaryRef:t,stateRef:n}=getPointsRefsForUser(e);try{await db.runTransaction(async a=>{const[s,r]=await Promise.all([a.get(t),a.get(n)]),o=(new Date).toISOString();s.exists?a.set(t,{userNickname:currentUser.name||"",updatedAt:o},{merge:!0}):a.set(t,{userId:e,userNickname:currentUser.name||"",balance:0,lifetimeEarned:0,updatedAt:o}),r.exists?a.set(n,{userNickname:currentUser.name||"",updatedAt:o},{merge:!0}):a.set(n,{userId:e,userNickname:currentUser.name||"",lastCheckinKstDate:null,currentStreakDays:0,claimed3:!1,claimed7:!1,claimed14:!1,totalDraws:0,totalWins:0,gachaPity:0,gachaNextLuck:null,updatedAt:o})})}catch(e){console.error("í¬ì¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:",e)}}function pointsTypeLabel(e){switch(e){case"EARN_ATTENDANCE":return"ì¶œì„ ì²´í¬";case"EARN_POST_PARTY":return"íŒŒí‹°ì› êµ¬í•´ìš” ê¸€ ì‘ì„±";case"EARN_POST_MEMBER":return"íŒŒí‹° êµ¬í•´ìš” ê¸€ ì‘ì„±";case"EARN_STREAK_3":return"3ì¼ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤";case"EARN_STREAK_7":return"7ì¼ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤";case"EARN_STREAK_14":return"14ì¼ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤";case"SPEND_GACHA":return"ë½‘ê¸° 1íšŒ";case"ADMIN_ADJUST":return"ê´€ë¦¬ì ì§€ê¸‰/íšŒìˆ˜";case"ROOT_BULK_ADJUST":return"í¬ì¸íŠ¸ ì¼ê´„ ì§€ê¸‰/íšŒìˆ˜";default:return e||""}}function fmtInt(e){const t=Number(e)||0;return Math.floor(t).toLocaleString()}function fmtRate(e){return`${(100*(Number(e)||0)).toFixed(1)}%`}let gachaEventCache={loadedAt:0,data:null};function parseKstDateTimeLocalToUtcIso(e){const t=String(e||"").trim();if(!t)return null;const[n,a]=t.split("T");if(!n||!a)return null;const[s,r,o]=n.split("-").map(e=>parseInt(e,10)),[i,l]=a.split(":").map(e=>parseInt(e,10));if(!(s&&r&&o&&Number.isFinite(i)&&Number.isFinite(l)))return null;const c=Date.UTC(s,r-1,o,i-9,l,0,0);return new Date(c).toISOString()}async function loadGachaEventConfig(e=!1){if(!db)return null;const t=Date.now();if(!e&&gachaEventCache.data&&t-gachaEventCache.loadedAt<3e4)return gachaEventCache.data;try{const e=await db.collection(FIRESTORE_POINTS.gachaEvent).doc("current").get(),n=e.exists?e.data():null;return gachaEventCache={loadedAt:t,data:n},n}catch(e){return console.error("gacha event config load failed:",e),null}}function isGachaEventActive(e,t=new Date){if(!e||!0!==(e?.eventEnabled??e?.enabled))return!1;const n=e.startAtUtc?new Date(e.startAtUtc):null,a=e.endAtUtc?new Date(e.endAtUtc):null;if(!n||Number.isNaN(n.getTime()))return!1;if(!a||Number.isNaN(a.getTime()))return!1;const s=t.getTime();return s>=n.getTime()&&s<=a.getTime()}function getGachaCost(e){const t=POINTS.COST_GACHA;if(!isGachaEventActive(e))return t;const n=Number(e?.costOverride);return Number.isFinite(n)&&n>=0?Math.floor(n):t}function getGachaBaseRate(e){if(!isGachaEventActive(e))return POINTS.BASE_RATE;const t=Number(e.multiplier)||1;return POINTS.BASE_RATE*Math.max(0,t)}function getGachaControl(e){return{gachaEnabled:!0===e?.gachaEnabled,roundNo:Number.isFinite(Number(e?.gachaRoundNo))?Math.floor(Number(e.gachaRoundNo)):null,maxWinners:Number.isFinite(Number(e?.gachaMaxWinners))?Math.floor(Number(e.gachaMaxWinners)):null,winnersCount:null}}function pickNextLuckTier(){const e=100*Math.random();return e<.5?"major":e<2?"minor":null}function computeWinRateForDraw({cfg:e,baseRate:t,nextLuckTier:n}){return isGachaEventActive(e)?"minor"===n?.02:"major"===n?.035:t:"minor"===n?t+.01:"major"===n?t+.03:t}async function getGachaWinnersCountBySlots(e,t){if(!db||!e||!t)return 0;try{const n=db.collection(FIRESTORE_POINTS.gachaRounds).doc(String(e)),a=Array.from({length:t},(e,t)=>n.collection("slots").doc(String(t+1)));return(await Promise.all(a.map(e=>e.get()))).filter(e=>e.exists).length}catch{return 0}}function formatFirestoreError(e){const t=e?.code?String(e.code):"",n=String(e?.message?e.message:e||"");return t&&n?`${t}: ${n}`:n||t||"unknown error"}async function callFunction(e,t={}){if(!functions)throw new Error("Functions ì´ˆê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.");const n=functions.httpsCallable(e),a=await n(t);return a?.data}function addDaysToDateKey(e,t){const[n,a,s]=String(e||"").split("-").map(e=>parseInt(e,10));if(!n||!a||!s)return null;const r=new Date(Date.UTC(n,a-1,s));return r.setUTCDate(r.getUTCDate()+(Number(t)||0)),r.toISOString().slice(0,10)}async function refreshPointsHeader(){if(!elements.pointsBalanceText)return;if(!db||!currentUser?.uid)return void(elements.pointsBalanceText.textContent="0pt");const e=currentUser.uid;try{const t=await db.collection(FIRESTORE_POINTS.summary).doc(e).get(),n=t.exists&&t.data()?.balance||0;elements.pointsBalanceText.textContent=`${fmtInt(n)}pt`}catch(e){console.error(e)}}function closePointsModal(){elements.pointsModal&&elements.pointsModal.classList.add("hidden")}function setPointsTabActive(e){elements.pointsTabBtns&&(elements.pointsTabBtns.forEach(t=>t.classList.toggle("active",t.dataset.pointsTab===e)),elements.pointsTabMe&&elements.pointsTabMe.classList.toggle("hidden","me"!==e),elements.pointsTabGacha&&elements.pointsTabGacha.classList.toggle("hidden","gacha"!==e),elements.pointsTabEvent&&elements.pointsTabEvent.classList.toggle("hidden","event"!==e),elements.pointsTabRanking&&elements.pointsTabRanking.classList.toggle("hidden","ranking"!==e),elements.pointsTabPublicLog&&elements.pointsTabPublicLog.classList.toggle("hidden","publicLog"!==e),elements.pointsTabAdmin&&elements.pointsTabAdmin.classList.toggle("hidden","admin"!==e))}async function switchPointsTab(e){setPointsTabActive(e),"ranking"===e&&await loadPointsRanking(),"publicLog"===e&&await loadPointsPublicAdminLog(),"gacha"===e&&await refreshGachaPanel(),"admin"===e&&await loadPendingApprovals(),"event"===e&&await refreshEventPanel()}async function openPointsModal(){if(!currentUser)return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."),void elements.authModal?.classList.remove("hidden");if(db){if(elements.pointsModal){if(elements.pointsModal.classList.remove("hidden"),setPointsTabActive("me"),!currentUser.pointsApproved&&!currentUser.isAdmin)return elements.pointsTabBtns&&elements.pointsTabBtns.forEach(e=>{const t=e.dataset.pointsTab;t&&(e.disabled="me"!==t)}),elements.attendanceBtn&&(elements.attendanceBtn.disabled=!0),elements.gachaDrawBtn&&(elements.gachaDrawBtn.disabled=!0),elements.pointsRefreshBtn&&(elements.pointsRefreshBtn.disabled=!0),elements.streakToday&&(elements.streakToday.textContent="í¬ì¸íŠ¸ ìŠ¹ì¸ í•„ìš”"),elements.streakHint&&(elements.streakHint.textContent="í¬ì¸íŠ¸ ê¸°ëŠ¥ì€ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."),elements.pointsLedgerList&&(elements.pointsLedgerList.innerHTML='<div class="points-empty">í¬ì¸íŠ¸ ê¸°ëŠ¥ì€ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>'),void(elements.gachaResult&&(elements.gachaResult.classList.remove("hidden"),elements.gachaResult.textContent="í¬ì¸íŠ¸ ìŠ¹ì¸ í›„ ë½‘ê¸°ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));elements.pointsTabBtns&&elements.pointsTabBtns.forEach(e=>{e.disabled=!1}),elements.attendanceBtn&&(elements.attendanceBtn.disabled=!1),elements.gachaDrawBtn&&(elements.gachaDrawBtn.disabled=!1),elements.pointsRefreshBtn&&(elements.pointsRefreshBtn.disabled=!1),await ensurePointDocsForCurrentUser(),await refreshPointsAll()}}else alert("DB ì—°ê²° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")}async function refreshPointsAll(e={}){db&&currentUser?.uid&&(await Promise.all([refreshPointsHeader(),refreshPointsMePanel(),loadMyPointLedger(),refreshGachaPanel()]),e.showToastOnDone&&showToast('<i class="fa-solid fa-rotate"></i> í¬ì¸íŠ¸ ì •ë³´ë¥¼ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤.'))}async function refreshPointsMePanel(){if(!db||!currentUser?.uid)return;const e=currentUser.uid,t=db.collection(FIRESTORE_POINTS.summary).doc(e),n=db.collection(FIRESTORE_POINTS.state).doc(e),a=getKstDateKeyFromNow();try{const[e,s]=await Promise.all([t.get(),n.get()]),r=e.exists?e.data():{},o=s.exists?s.data():{},i=Number(r?.balance)||0,l=Number(r?.lifetimeEarned)||0;elements.pointsMeBalance&&(elements.pointsMeBalance.textContent=`${fmtInt(i)}pt`),elements.pointsMeLifetime&&(elements.pointsMeLifetime.textContent=`${fmtInt(l)}pt`);const c=o?.lastCheckinKstDate||null,d=Number(o?.currentStreakDays)||0,m=!!o?.claimed3,u=!!o?.claimed7,p=!!o?.claimed14,g=c===a;elements.streakToday&&(elements.streakToday.textContent=`ì˜¤ëŠ˜: ${g?"ì™„ë£Œ":"ë¯¸ì™„ë£Œ"} (KST ${a})`),elements.streakDays&&(elements.streakDays.textContent=String(d));let h=null;m?u?p||(h=14):h=7:h=3,elements.streakNext&&(elements.streakNext.textContent=h?`${h}ì¼`:"-");const f=h?Math.min(d,h)/h:1;elements.streakBar&&(elements.streakBar.style.width=`${Math.round(100*f)}%`),elements.streakHint&&(elements.streakHint.textContent=h?d>=h?"ë‹¤ìŒ ì¶œì„ ì‹œ ë³´ë„ˆìŠ¤ê°€ ì´ë¯¸ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ì¦‰ì‹œ ì§€ê¸‰ë©ë‹ˆë‹¤.":h-d+"ì¼ ë” ì¶œì„í•˜ë©´ ë³´ë„ˆìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆì–´ìš”.":"14ì¼ ë³´ë„ˆìŠ¤ê¹Œì§€ ëª¨ë‘ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.")}catch(e){console.error(e)}}function renderLedgerRows(e){elements.pointsLedgerList&&(e.length?elements.pointsLedgerList.innerHTML=e.map(e=>{const t=Number(e.delta)||0,n=t>=0,a=pointsTypeLabel(e.type),s=e.kstDate?`KST ${e.kstDate}`:"",r=e.createdAt&&formatKst(e.createdAt)||"",o=e.reasonText?`ì‚¬ìœ : ${e.reasonText}`:"",i=e.adminNickname||e.adminUserId||"",l=[s,r?`(${r})`:null,o,"ADMIN_ADJUST"===e.type||"ROOT_BULK_ADJUST"===e.type?i?`ì§€ê¸‰ì: ${i}`:"ì§€ê¸‰ì:":""].filter(Boolean).join("\n");return`\n            <div class="points-row">\n                <div class="left">\n                    <div class="title">${escapeHtml(a)}</div>\n                    <div class="meta">${escapeHtml(l)}</div>\n                </div>\n                <div class="delta ${n?"plus":"minus"}">${n?"+":""}${fmtInt(t)}pt</div>\n            </div>\n        `}).join(""):elements.pointsLedgerList.innerHTML='<div class="points-empty">í‘œì‹œí•  ì›ì¥ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>')}async function loadMyPointLedger(){if(!db||!currentUser?.uid||!elements.pointsLedgerList)return;const e=currentUser.uid,{ledgerCol:t}=getPointsRefsForUser(e);try{const e=await t.orderBy("createdAt","desc").limit(20).get(),n=[];e.forEach(e=>n.push({id:e.id,...e.data()})),renderLedgerRows(n)}catch(e){console.error(e),elements.pointsLedgerList.innerHTML=`<div class="points-empty">ì›ì¥ ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(formatFirestoreError(e))}</div>`}}async function doAttendanceCheck(e={}){if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");if(!currentUser?.uid)return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!currentUser.pointsApproved&&!currentUser.isAdmin)return alert("í¬ì¸íŠ¸ ê¸°ëŠ¥ì€ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");const t=!!e.silent,n=currentUser.uid,a=getKstDateKeyFromNow(),s=getIsoWeekKeyFromKstNow(),r=(new Date).toISOString(),o=addDaysToDateKey(a,-1),{summaryRef:i,stateRef:l,ledgerCol:c}=getPointsRefsForUser(n),d=c.doc(`EARN_ATTENDANCE__${a}`),m=db.collection(FIRESTORE_POINTS.counters).doc(`D__${n}__ATTENDANCE__${a}`),u=db.collection(FIRESTORE_POINTS.counters).doc(`W__${n}__ATTENDANCE__${s}`),p={b3:c.doc(`EARN_STREAK_3__${a}`),b7:c.doc(`EARN_STREAK_7__${a}`),b14:c.doc(`EARN_STREAK_14__${a}`)};try{const e=await db.runTransaction(async e=>{const[t,c,g,h,f,y,v,E]=await Promise.all([e.get(d),e.get(m),e.get(u),e.get(i),e.get(l),e.get(p.b3),e.get(p.b7),e.get(p.b14)]);if(t.exists)return{ok:!1,code:"already"};const b=Number(c.exists?c.data()?.count:0)||0,T=Number(g.exists?g.data()?.count:0)||0;if(b>=POINTS.LIMITS.ATTENDANCE.daily)return{ok:!1,code:"daily_limit"};if(T>=POINTS.LIMITS.ATTENDANCE.weekly)return{ok:!1,code:"weekly_limit"};const I=h.exists?h.data():{},S=f.exists?f.data():{},A=Number(I?.balance)||0,w=Number(I?.lifetimeEarned)||0;let B=Number(S?.currentStreakDays)||0,L=!!S?.claimed3,C=!!S?.claimed7,P=!!S?.claimed14;S?.lastCheckinKstDate===o?B+=1:(B=1,L=!1,C=!1,P=!1);let k=0;return B>=3&&!L&&!y.exists&&(k+=POINTS.EARN.STREAK_3,L=!0,e.set(p.b3,{userId:n,userNickname:currentUser.name,type:"EARN_STREAK_3",delta:POINTS.EARN.STREAK_3,refType:"attendance_streak",refId:"3",reasonText:null,createdAt:r,kstDate:a,kstWeekKey:s})),B>=7&&!C&&!v.exists&&(k+=POINTS.EARN.STREAK_7,C=!0,e.set(p.b7,{userId:n,userNickname:currentUser.name,type:"EARN_STREAK_7",delta:POINTS.EARN.STREAK_7,refType:"attendance_streak",refId:"7",reasonText:null,createdAt:r,kstDate:a,kstWeekKey:s})),B>=14&&!P&&!E.exists&&(k+=POINTS.EARN.STREAK_14,P=!0,e.set(p.b14,{userId:n,userNickname:currentUser.name,type:"EARN_STREAK_14",delta:POINTS.EARN.STREAK_14,refType:"attendance_streak",refId:"14",reasonText:null,createdAt:r,kstDate:a,kstWeekKey:s})),e.set(d,{userId:n,userNickname:currentUser.name,type:"EARN_ATTENDANCE",delta:POINTS.EARN.ATTENDANCE,refType:"attendance",refId:a,reasonText:null,createdAt:r,kstDate:a,kstWeekKey:s}),e.set(m,{userId:n,action:"ATTENDANCE",scope:"D",key:a,count:firebase.firestore.FieldValue.increment(1),updatedAt:r},{merge:!0}),e.set(u,{userId:n,action:"ATTENDANCE",scope:"W",key:s,count:firebase.firestore.FieldValue.increment(1),updatedAt:r},{merge:!0}),e.set(i,{userId:n,userNickname:currentUser.name,balance:A+POINTS.EARN.ATTENDANCE+k,lifetimeEarned:w+POINTS.EARN.ATTENDANCE+k,updatedAt:r},{merge:!0}),e.set(l,{userId:n,userNickname:currentUser.name,lastCheckinKstDate:a,currentStreakDays:B,claimed3:L,claimed7:C,claimed14:P,updatedAt:r},{merge:!0}),{ok:!0,streakDays:B,bonusTotal:k}});if(!e?.ok){if(t)return;return"already"===e.code?showToast('<i class="fa-solid fa-circle-info"></i> ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„ ì²´í¬ë¥¼ í–ˆìŠµë‹ˆë‹¤.'):"daily_limit"===e.code?showToast('<i class="fa-solid fa-circle-info"></i> ì¶œì„ì€ ì¼ì¼ ìµœëŒ€ 1íšŒì…ë‹ˆë‹¤.'):"weekly_limit"===e.code?showToast('<i class="fa-solid fa-circle-info"></i> ì¶œì„ì€ ì£¼ê°„ ìµœëŒ€ 7íšŒì…ë‹ˆë‹¤.'):showToast('<i class="fa-solid fa-circle-info"></i> ì¶œì„ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}const c=e.bonusTotal>0?` (+ë³´ë„ˆìŠ¤ ${fmtInt(e.bonusTotal)}pt)`:"";showToast(`<i class="fa-solid fa-calendar-check"></i> ì¶œì„ ì™„ë£Œ +${POINTS.EARN.ATTENDANCE}pt${c}`),await refreshPointsAll()}catch(e){console.error(e),t||alert("ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n"+formatFirestoreError(e))}}async function awardPostCreatePoints(e,t){if(!db||!currentUser?.uid)return;if(!currentUser.pointsApproved&&!currentUser.isAdmin)return;if(!t)return;const n=currentUser.uid,a=getKstDateKeyFromNow(),s=getIsoWeekKeyFromKstNow(),r=(new Date).toISOString(),o="party"===e;if(!o&&!("member"===e))return;const i=o?"POST_PARTY":"POST_MEMBER",l=o?POINTS.LIMITS.POST_PARTY:POINTS.LIMITS.POST_MEMBER,c=o?"EARN_POST_PARTY":"EARN_POST_MEMBER",{summaryRef:d,ledgerCol:m}=getPointsRefsForUser(n),u=m.doc(`${c}__${t}`),p=db.collection(FIRESTORE_POINTS.counters).doc(`D__${n}__${i}__${a}`),g=db.collection(FIRESTORE_POINTS.counters).doc(`W__${n}__${i}__${s}`);try{const e=await db.runTransaction(async e=>{const[o,m,h,f]=await Promise.all([e.get(u),e.get(p),e.get(g),e.get(d)]);if(o.exists)return{ok:!1,code:"already"};const y=Number(m.exists?m.data()?.count:0)||0,v=Number(h.exists?h.data()?.count:0)||0;if(y>=l.daily)return{ok:!1,code:"daily_limit"};if(v>=l.weekly)return{ok:!1,code:"weekly_limit"};const E=f.exists?f.data():{},b=Number(E?.balance)||0,T=Number(E?.lifetimeEarned)||0;return e.set(u,{userId:n,userNickname:currentUser.name,type:c,delta:POINTS.EARN.POST,refType:"post",refId:String(t),reasonText:null,createdAt:r,kstDate:a,kstWeekKey:s}),e.set(p,{userId:n,action:i,scope:"D",key:a,count:firebase.firestore.FieldValue.increment(1),updatedAt:r},{merge:!0}),e.set(g,{userId:n,action:i,scope:"W",key:s,count:firebase.firestore.FieldValue.increment(1),updatedAt:r},{merge:!0}),e.set(d,{userId:n,userNickname:currentUser.name,balance:b+POINTS.EARN.POST,lifetimeEarned:T+POINTS.EARN.POST,updatedAt:r},{merge:!0}),{ok:!0}});e?.ok&&(showToast(`<i class="fa-solid fa-coins"></i> í¬ì¸íŠ¸ +${POINTS.EARN.POST}pt (ê¸€ ì‘ì„±)`),await refreshPointsHeader())}catch(e){console.error("ê²Œì‹œê¸€ í¬ì¸íŠ¸ ì§€ê¸‰ ì‹¤íŒ¨:",e)}}async function refreshGachaPanel(e={}){if(!db||!currentUser?.uid)return;const t=currentUser.uid,n=db.collection(FIRESTORE_POINTS.state).doc(t);try{const t=await loadGachaEventConfig(!1),a=await n.get(),s=a.exists?a.data():{},r=Number(s?.totalDraws)||0,o=isGachaEventActive(t),i=o?String(t?.publicText||"ì§„í–‰ì¤‘"):"-",l=getGachaCost(t),c=getGachaControl(t),d=await getGachaWinnersCountBySlots(c.roundNo,c.maxWinners);elements.gachaTotalDraws&&(elements.gachaTotalDraws.textContent=fmtInt(r)),elements.gachaEventBadge&&(elements.gachaEventBadge.textContent=i),elements.gachaCostText&&(o&&l!==POINTS.COST_GACHA?elements.gachaCostText.innerHTML=`<del style="opacity:.55;">${fmtInt(POINTS.COST_GACHA)}pt</del> <span style="color: var(--warning); font-weight: 900;">${fmtInt(l)}pt</span>`:elements.gachaCostText.textContent=`${fmtInt(POINTS.COST_GACHA)}pt`);const m=elements.pointsTabGacha?.querySelector?.(".points-card");if(m&&m.classList.toggle("gacha-event-glow",o),elements.gachaRoundText&&(elements.gachaRoundText.textContent=c.roundNo?`${c.roundNo}íšŒì°¨`:"-"),elements.gachaWinnersText&&(c.roundNo&&c.maxWinners?elements.gachaWinnersText.textContent=`${d}/${c.maxWinners}`:elements.gachaWinnersText.textContent="-"),elements.gachaDrawBtn){const e=c.gachaEnabled&&c.roundNo&&c.maxWinners&&d<c.maxWinners;elements.gachaDrawBtn.disabled=!e}elements.gachaResult&&(c.gachaEnabled?elements.gachaResult.textContent.includes("ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤")&&(elements.gachaResult.classList.add("hidden"),elements.gachaResult.textContent=""):(elements.gachaResult.classList.remove("hidden"),elements.gachaResult.textContent="í˜„ì¬ ë½‘ê¸°ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ íšŒì°¨ë¥¼ ê¸°ëŒ€í•´ ì£¼ì„¸ìš”! ğŸ–ï¸",elements.gachaResult.style.borderColor="rgba(239,68,68,0.55)",elements.gachaResult.style.background="rgba(239,68,68,0.08)")),await loadGachaWinnersList(c.roundNo),e.showToastOnDone&&showToast('<i class="fa-solid fa-rotate"></i> ë½‘ê¸° ì •ë³´ë¥¼ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤.')}catch(e){console.error(e)}}async function doGachaDraw(){if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");if(!currentUser?.uid)return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!currentUser.pointsApproved&&!currentUser.isAdmin)return alert("í¬ì¸íŠ¸ ê¸°ëŠ¥ì€ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");const e=currentUser.uid,t=getKstDateKeyFromNow(),n=getIsoWeekKeyFromKstNow(),a=(new Date).toISOString(),s=await loadGachaEventConfig(!1),r=getGachaBaseRate(s),o=getGachaCost(s),i=getGachaControl(s);if(!i.gachaEnabled)return showToast('<i class="fa-solid fa-circle-info"></i> í˜„ì¬ ë½‘ê¸°ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');if(!i.roundNo||!i.maxWinners)return showToast('<i class="fa-solid fa-circle-info"></i> ë½‘ê¸° íšŒì°¨/ë‹¹ì²¨ ì¸ì› ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');if(i.winnersCount>=i.maxWinners)return showToast('<i class="fa-solid fa-circle-info"></i> ì´ë²ˆ íšŒì°¨ ë½‘ê¸°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');const{summaryRef:l,stateRef:c,ledgerCol:d,drawsCol:m}=getPointsRefsForUser(e),u=`${Date.now()}_${Math.random().toString(16).slice(2)}`,p=d.doc(`SPEND_GACHA__${u}`),g=m.doc(u),h=()=>{elements.gachaRollStage&&elements.gachaRollStage.classList.add("hidden"),elements.gachaDrawBtn&&(elements.gachaDrawBtn.disabled=!1),elements.gachaRefreshBtn&&(elements.gachaRefreshBtn.disabled=!1)},f=["í–‰ìš´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦","ë£°ë ›ì´ ëŒì•„ê°€ëŠ” ì¤‘â€¦","ê²°ê³¼ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘â€¦","ë§ˆì§€ë§‰ í•œ ë²ˆ ë”â€¦"];elements.gachaResult&&elements.gachaResult.classList.add("hidden"),elements.gachaRollStage&&elements.gachaRollStage.classList.remove("hidden"),elements.gachaDrawBtn&&(elements.gachaDrawBtn.disabled=!0),elements.gachaRefreshBtn&&(elements.gachaRefreshBtn.disabled=!0);let y=null;if(elements.gachaRollText){let e=0;elements.gachaRollText.textContent=f[0],y=setInterval(()=>{e=(e+1)%f.length,elements.gachaRollText.textContent=f[e]},450)}try{const d=db.runTransaction(async d=>{const m=db.collection(FIRESTORE_POINTS.gachaEvent).doc("current"),h=db.collection(FIRESTORE_POINTS.gachaRounds).doc(String(i.roundNo)),f=h.collection("winners").doc(e),y=Array.from({length:i.maxWinners},(e,t)=>h.collection("slots").doc(String(t+1))),[v,E,b,T,I,...S]=await Promise.all([d.get(l),d.get(c),d.get(p),d.get(m),d.get(f),...y.map(e=>d.get(e))]);if(b.exists)return{ok:!1,code:"already"};if(I.exists)return{ok:!1,code:"already_winner"};const A=getGachaControl(T.exists&&T.data()||{});if(!A.gachaEnabled)return{ok:!1,code:"gacha_disabled"};if(!A.roundNo||!A.maxWinners)return{ok:!1,code:"gacha_unconfigured"};if(A.roundNo!==i.roundNo)return{ok:!1,code:"round_changed"};if(S.filter(e=>e.exists).length>=A.maxWinners)return{ok:!1,code:"round_ended"};if(S.some(t=>t.exists&&t.data()?.uid===e))return{ok:!1,code:"already_winner"};const w=v.exists?v.data():{},B=Number(w?.balance)||0;if(B<o)return{ok:!1,code:"insufficient",need:o};const L=E.exists?E.data():{},C=Number(L?.totalDraws)||0,P=L?.gachaNextLuck||null,k=computeWinRateForDraw({cfg:s,baseRate:r,nextLuckTier:P}),D=new Uint32Array(1);crypto.getRandomValues(D);const R=D[0]%1e6,N=R<Math.floor(1e6*k);let M=null,x=null;if(N||(x=pickNextLuckTier(),M=x),d.set(p,{userId:e,userNickname:currentUser.name,type:"SPEND_GACHA",delta:-o,refType:"gacha_draw",refId:u,reasonText:null,createdAt:a,kstDate:t,kstWeekKey:n}),d.set(g,{userId:e,userNickname:currentUser.name,createdAt:a,kstDate:t,costPoints:o,baseRate:r,winRateApplied:k,nextLuckUsed:P,userTotalDrawsBefore:C,rngRoll:R,isWin:N,loseLuckOutcome:x}),N){const t=S.findIndex(e=>!e.exists);if(t<0)return{ok:!1,code:"round_ended"};const n=y[t];d.set(n,{uid:e,nickname:currentUser.name||"",wonAt:a,drawId:u,roundNo:A.roundNo,slotNo:t+1}),d.set(f,{uid:e,nickname:currentUser.name||"",wonAt:a,drawId:u,roundNo:A.roundNo})}return d.set(l,{userId:e,userNickname:currentUser.name,balance:B-o,updatedAt:a},{merge:!0}),d.set(c,{userId:e,userNickname:currentUser.name,totalDraws:C+1,totalWins:(Number(L?.totalWins)||0)+(N?1:0),gachaPity:0,gachaNextLuck:M,updatedAt:a},{merge:!0}),{ok:!0,isWin:N,roll:R,usedNextLuck:P,newNextLuck:M,eventActive:isGachaEventActive(s)}}),[m]=await Promise.all([d,sleep(1400)]);if(y&&clearInterval(y),h(),!m?.ok)return"insufficient"===m.code?showToast(`<i class="fa-solid fa-circle-info"></i> í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš” ${fmtInt(m.need||o)}pt)`):"already_winner"===m.code?showToast('<i class="fa-solid fa-circle-info"></i> ì´ë²ˆ íšŒì°¨ì—ì„œ ì´ë¯¸ ë‹¹ì²¨ë˜ì–´ ë” ì´ìƒ ë½‘ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'):"gacha_disabled"===m.code?showToast('<i class="fa-solid fa-circle-info"></i> í˜„ì¬ ë½‘ê¸°ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'):"gacha_unconfigured"===m.code?showToast('<i class="fa-solid fa-circle-info"></i> ë½‘ê¸° íšŒì°¨/ë‹¹ì²¨ ì¸ì› ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.'):"round_ended"===m.code?showToast('<i class="fa-solid fa-circle-info"></i> ì´ë²ˆ íšŒì°¨ ë½‘ê¸°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'):"round_changed"===m.code?showToast('<i class="fa-solid fa-circle-info"></i> íšŒì°¨ ì •ë³´ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'):showToast('<i class="fa-solid fa-circle-info"></i> ë½‘ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');let f="";m.isWin?f="ê²°ê³¼: ë‹¹ì²¨\n\nì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰":(f="minor"===m.newNextLuck?"ê²°ê³¼: ê½\në½‘ê¸° ë³´ìƒìœ¼ë¡œ í–‰ìš´ì´ ì ìš©ë˜ì–´ ë‹¤ìŒ ë½‘ê¸° í™•ë¥  ì†Œí­ ì¦ê°€ ğŸ§š":"major"===m.newNextLuck?"ê²°ê³¼: ê½\në½‘ê¸° ë³´ìƒìœ¼ë¡œ í–‰ìš´ì´ ì ìš©ë˜ì–´ ë‹¤ìŒ ë½‘ê¸° í™•ë¥  ğŸ‰ ëŒ€í­ ì¦ê°€ ğŸ‰":"ê²°ê³¼: ê½\në½‘ê¸° ë³´ìƒì„ íšë“í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤. ğŸ¥²",m.eventActive&&(f+="\n\nâ€» ì´ë²¤íŠ¸ ì§„í–‰ì¤‘")),elements.gachaResult&&(elements.gachaResult.classList.remove("hidden"),elements.gachaResult.textContent=f,m.isWin?(elements.gachaResult.style.borderColor="rgba(16, 185, 129, 0.6)",elements.gachaResult.style.background="rgba(16, 185, 129, 0.10)"):(elements.gachaResult.style.borderColor="var(--border)",elements.gachaResult.style.background="rgba(255,255,255,0.03)")),m.isWin?(showToast('<i class="fa-solid fa-trophy"></i> ë‹¹ì²¨! (í™•ë¥  ì´ˆê¸°í™”)'),launchConfetti(),sendGachaWinToDiscord(["ğŸ‰ **ë½‘ê¸° ë‹¹ì²¨!**",`- ë‹‰ë„¤ì„: ${currentUser?.name||""}`,`- uid: ${currentUser?.uid||""}`,`- ì‹œê°(KST): ${formatKst((new Date).toISOString())||""}`].join("\n"))):showToast('<i class="fa-solid fa-dice"></i> ë½‘ê¸° ì™„ë£Œ'),await refreshPointsAll()}catch(e){y&&clearInterval(y),h(),console.error(e),alert("ë½‘ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n"+formatFirestoreError(e))}}function launchConfetti(){const e=document.createElement("div");e.className="confetti-container",document.body.appendChild(e);const t=["#a78bfa","#8b5cf6","#22c55e","#fbbf24","#60a5fa","#f472b6"];for(let n=0;n<90;n++){const a=document.createElement("div");a.className="confetti-piece";const s=100*Math.random(),r=260*(Math.random()-.5),o=720*(Math.random()-.5),i=180*Math.random(),l=900+700*Math.random(),c=6+10*Math.random(),d=8+14*Math.random();a.style.left=`${s}vw`,a.style.background=t[n%t.length],a.style.width=`${c}px`,a.style.height=`${d}px`,a.style.borderRadius=4*Math.random()+"px",a.style.setProperty("--x",`${r}px`),a.style.setProperty("--r",`${o}deg`),a.style.animationDelay=`${i}ms`,a.style.animationDuration=`${l}ms`,e.appendChild(a)}setTimeout(()=>{e.remove()},2500)}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function loadPointsRanking(){if(db&&elements.pointsRankingList)try{const e=await db.collection(FIRESTORE_POINTS.summary).orderBy("lifetimeEarned","desc").limit(50).get(),t=[];if(e.forEach(e=>t.push({id:e.id,...e.data()})),!t.length)return void(elements.pointsRankingList.innerHTML='<div class="points-empty">ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');elements.pointsRankingList.innerHTML=t.map((e,t)=>{const n=e.userNickname||e.id,a=Number(e.lifetimeEarned)||0,s=Number(e.balance)||0;return`\n                <div class="points-row" style="${currentUser?.name&&n===currentUser.name?"background: rgba(139,92,246,0.10);":""}">\n                    <div class="left">\n                        <div class="title">#${t+1} ${escapeHtml(n)}</div>\n                        <div class="meta">ëˆ„ì  íšë“: ${fmtInt(a)}pt\ní˜„ì¬ ë³´ìœ : ${fmtInt(s)}pt</div>\n                    </div>\n                    <div class="delta plus">${fmtInt(a)}pt</div>\n                </div>\n            `}).join("")}catch(e){console.error(e),elements.pointsRankingList.innerHTML=`<div class="points-empty">ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(formatFirestoreError(e))}</div>`}}async function loadPointsPublicAdminLog(){if(db&&elements.pointsPublicAdminLogList)try{const e=await db.collection(FIRESTORE_POINTS.publicAdminLog).orderBy("createdAt","desc").limit(100).get(),t=[];if(e.forEach(e=>t.push({id:e.id,...e.data()})),!t.length)return void(elements.pointsPublicAdminLogList.innerHTML='<div class="points-empty">í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');elements.pointsPublicAdminLogList.innerHTML=t.map(e=>{const t=Number(e.delta)||0,n=t>=0,a=e.adminNickname||e.adminId||"(unknown)",s=e.targetNickname||e.targetUserId||"(unknown)",r=formatKst(e.createdAt)||"",o=e.reasonText||"",i="ROOT_BULK_ADJUST"===e.type?`\nì²˜ë¦¬: ${fmtInt(e.processedCount||0)}ëª… / ì œì™¸: ${fmtInt(e.skippedCount||0)}ëª…`:"";return`\n                <div class="points-row">\n                    <div class="left">\n                        <div class="title">${escapeHtml(a)} â†’ ${escapeHtml(s)}</div>\n                        <div class="meta">${escapeHtml(r)}\nì‚¬ìœ : ${escapeHtml(o)}${escapeHtml(i)}</div>\n                    </div>\n                    <div class="delta ${n?"plus":"minus"}">${n?"+":""}${fmtInt(t)}pt</div>\n                </div>\n            `}).join("")}catch(e){console.error(e),elements.pointsPublicAdminLogList.innerHTML=`<div class="points-empty">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(formatFirestoreError(e))}</div>`}}async function loadPendingApprovals(){if(db&&elements.pendingApprovalsList)if(currentUser?.isAdmin){elements.pendingApprovalsList.innerHTML='<div class="points-empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';try{const e=await db.collection(FIRESTORE_POINTS.userProfiles).where("pointsApproved","==",!1).limit(100).get(),t=[];if(e.forEach(e=>t.push({id:e.id,...e.data()})),t.sort((e,t)=>{const n=e.createdAt?.toMillis?e.createdAt.toMillis():0;return(t.createdAt?.toMillis?t.createdAt.toMillis():0)-n}),!t.length)return void(elements.pendingApprovalsList.innerHTML='<div class="points-empty">ìŠ¹ì¸ ëŒ€ê¸° ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');elements.pendingApprovalsList.innerHTML=t.map(e=>{const t=e.nickname||"(ë‹‰ë„¤ì„ ì—†ìŒ)",n=e.createdAt?.toDate?e.createdAt.toDate().toISOString():null,a=n&&formatKst(n)||"";return`\n                <div class="points-row">\n                    <div class="left">\n                        <div class="title">${escapeHtml(t)}</div>\n                        <div class="meta">uid: ${escapeHtml(e.uid||e.id)}\nê°€ì…: ${escapeHtml(a)}</div>\n                    </div>\n                    <div style="display:flex; gap:8px; flex-wrap:wrap;">\n                        <button class="btn-success" onclick="approvePointsForUser('${escapeHtml(e.uid||e.id)}')"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>\n                    </div>\n                </div>\n            `}).join("")}catch(e){console.error(e),elements.pendingApprovalsList.innerHTML=`<div class="points-empty">ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(formatFirestoreError(e))}</div>`}}else elements.pendingApprovalsList.innerHTML='<div class="points-empty">ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>'}async function renderGachaEventConfigForRoot(){if(!elements.rootEventCard||!currentUser?.isRoot)return;const e=await loadGachaEventConfig(!0);if(!e)return void(elements.gachaEventStatusText&&(elements.gachaEventStatusText.textContent="í˜„ì¬ ì €ì¥ëœ ì´ë²¤íŠ¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤."));const t=e.eventEnabled??e.enabled??!1;elements.gachaEventEnabled&&(elements.gachaEventEnabled.value=t?"true":"false"),elements.gachaEventMultiplier&&(elements.gachaEventMultiplier.value=String(e.multiplier??"")),elements.gachaEventCostOverride&&(elements.gachaEventCostOverride.value=null===e.costOverride||void 0===e.costOverride?"":String(e.costOverride)),elements.gachaEventMessage&&(elements.gachaEventMessage.value=String(e.publicText||""));const n=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";return new Date(t.getTime()+324e5).toISOString().slice(0,16)};elements.gachaEventStartKst&&(elements.gachaEventStartKst.value=n(e.startAtUtc)),elements.gachaEventEndKst&&(elements.gachaEventEndKst.value=n(e.endAtUtc));const a=isGachaEventActive(e);if(elements.gachaEventStatusText){const n=e.startAtUtc&&formatKst(e.startAtUtc)||"",s=e.endAtUtc&&formatKst(e.endAtUtc)||"";elements.gachaEventStatusText.textContent=`í™•ë¥  ì´ë²¤íŠ¸: ${t?a?"ì§„í–‰ì¤‘":"ëŒ€ê¸°/ì¢…ë£Œ":"ë¹„í™œì„±"}\nê¸°ê°„(KST): ${n} ~ ${s}\në°°ìˆ˜: ${e.multiplier??""}`}}async function renderGachaControlForRoot(){if(!elements.rootGachaControlCard||!currentUser?.isRoot)return;const e=await loadGachaEventConfig(!0);e?(elements.gachaEnabled&&(elements.gachaEnabled.value=!0===e.gachaEnabled?"true":"false"),elements.gachaRoundNo&&(elements.gachaRoundNo.value=String(e.gachaRoundNo??"")),elements.gachaMaxWinners&&(elements.gachaMaxWinners.value=String(e.gachaMaxWinners??"")),elements.gachaControlStatusText&&(elements.gachaControlStatusText.textContent=`ë½‘ê¸°: ${!0===e.gachaEnabled?"í™œì„±":"ë¹„í™œì„±"} / íšŒì°¨: ${e.gachaRoundNo??"-"} / ë‹¹ì²¨: ${e.gachaWinnersCount??0}/${e.gachaMaxWinners??"-"}`)):elements.gachaControlStatusText&&(elements.gachaControlStatusText.textContent="í˜„ì¬ ì €ì¥ëœ ë½‘ê¸° ìš´ì˜ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.")}async function saveGachaControlConfig(){if(!currentUser?.isRoot)return alert("ROOTë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");const e="true"===String(elements.gachaEnabled?.value||"false"),t=Math.max(1,Math.floor(parseFloat(elements.gachaRoundNo?.value||"1")||1)),n=Math.max(1,Math.floor(parseFloat(elements.gachaMaxWinners?.value||"1")||1)),a=db.collection(FIRESTORE_POINTS.gachaEvent).doc("current");try{const s=await a.get().then(e=>e.exists&&e.data()||{}).catch(()=>({})),r=(s?.gachaRoundNo??null)!==t;await a.set({gachaEnabled:e,gachaRoundNo:t,gachaMaxWinners:n,gachaWinnersCount:r?0:s?.gachaWinnersCount??0,updatedAt:(new Date).toISOString(),updatedBy:currentUser.uid},{merge:!0}),await db.collection(FIRESTORE_POINTS.gachaRounds).doc(String(t)).set({roundNo:t,maxWinners:n,updatedAt:(new Date).toISOString(),updatedBy:currentUser.uid},{merge:!0}),showToast('<i class="fa-solid fa-floppy-disk"></i> ë½‘ê¸° ìš´ì˜ ì €ì¥ ì™„ë£Œ'),await loadGachaEventConfig(!0),await Promise.all([renderGachaControlForRoot(),refreshGachaPanel()])}catch(e){console.error(e),alert("ì €ì¥ ì‹¤íŒ¨:\n\n"+formatFirestoreError(e))}}async function saveGachaEventConfig(){if(!currentUser?.isRoot)return alert("ROOTë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");const e="true"===String(elements.gachaEventEnabled?.value||"false"),t=elements.gachaEventStartKst?.value||"",n=elements.gachaEventEndKst?.value||"",a=parseFloat(elements.gachaEventMultiplier?.value||"1")||1,s=String(elements.gachaEventCostOverride?.value||"").trim(),r=s?Math.max(0,Math.floor(parseFloat(s)||0)):null,o=String(elements.gachaEventMessage?.value||"").trim(),i=parseKstDateTimeLocalToUtcIso(t),l=parseKstDateTimeLocalToUtcIso(n);if(e){if(!i||!l)return alert("ì‹œì‘/ì¢…ë£Œ(KST)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");if(new Date(i).getTime()>new Date(l).getTime())return alert("ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.");if(!(a>=0))return alert("ë°°ìˆ˜ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.")}const c=db.collection(FIRESTORE_POINTS.gachaEvent).doc("current");try{await c.set({eventEnabled:e,startAtUtc:i,endAtUtc:l,multiplier:a,costOverride:r,publicText:o,updatedAt:(new Date).toISOString(),updatedBy:currentUser.uid},{merge:!0}),showToast('<i class="fa-solid fa-wand-magic-sparkles"></i> ì´ë²¤íŠ¸ ì„¤ì • ì €ì¥ ì™„ë£Œ'),await loadGachaEventConfig(!0),await Promise.all([renderGachaEventConfigForRoot(),refreshGachaPanel(),refreshEventPanel()])}catch(e){console.error(e),alert("ì €ì¥ ì‹¤íŒ¨:\n\n"+formatFirestoreError(e))}}async function refreshEventPanel(){const e=await loadGachaEventConfig(!1),t=isGachaEventActive(e),n=String(e?.publicText||"").trim(),a=getGachaControl(e);if(elements.eventPublicBox)if(t){const t=e?.startAtUtc&&formatKst(e.startAtUtc)||"",s=e?.endAtUtc&&formatKst(e.endAtUtc)||"",r=getGachaCost(e),o=r!==POINTS.COST_GACHA?`- ë¹„ìš©: ${POINTS.COST_GACHA} â†’ ${r}`:`- ë¹„ìš©: ${POINTS.COST_GACHA}`;elements.eventPublicBox.textContent=(n?`${n}\n\n`:"")+"ìƒíƒœ: ì§„í–‰ì¤‘\n"+`ê¸°ê°„(KST): ${t} ~ ${s}\n`+`- í™•ë¥  ë°°ìˆ˜: ${e?.multiplier??""}\n`+`- ë½‘ê¸°: ${a.gachaEnabled?"í™œì„±":"ë¹„í™œì„±"} / íšŒì°¨: ${a.roundNo||"-"} / ë‹¹ì²¨: ${a.winnersCount}/${a.maxWinners||"-"}\n`+`${o}`}else elements.eventPublicBox.textContent=(n?`${n}\n\n`:"")+`ìƒíƒœ: ${a.gachaEnabled?"ë½‘ê¸° í™œì„±":"ë½‘ê¸° ë¹„í™œì„±"} / íšŒì°¨: ${a.roundNo||"-"} / ë‹¹ì²¨: ${a.winnersCount}/${a.maxWinners||"-"}\n`+(n?"":"í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");await Promise.all([renderGachaControlForRoot(),renderGachaEventConfigForRoot()])}async function loadGachaWinnersList(e){if(elements.gachaWinnersList)if(db&&e)try{const t=db.collection(FIRESTORE_POINTS.gachaRounds).doc(String(e)).collection("winners"),n=await t.orderBy("wonAt","desc").limit(50).get(),a=[];if(n.forEach(e=>a.push({id:e.id,...e.data()})),!a.length)return void(elements.gachaWinnersList.innerHTML='<div class="points-empty">ì•„ì§ ë‹¹ì²¨ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>');elements.gachaWinnersList.innerHTML=a.map((e,t)=>{const n=e.nickname||e.id,a=e.wonAt?formatKst(e.wonAt)||e.wonAt:"";return`\n                <div class="points-row">\n                    <div class="left">\n                        <div class="title">#${t+1} ${escapeHtml(n)}</div>\n                        <div class="meta">${escapeHtml(a)}</div>\n                    </div>\n                    <div class="delta plus">ë‹¹ì²¨</div>\n                </div>\n            `}).join("")}catch(e){console.error(e),elements.gachaWinnersList.innerHTML=`<div class="points-empty">ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(formatFirestoreError(e))}</div>`}else elements.gachaWinnersList.innerHTML='<div class="points-empty">íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'}async function rootBulkAdjustAllUsers(){if(!currentUser?.isRoot)return alert("ROOTë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");const e=String(elements.rootBulkMode?.value||"grant"),t=Math.floor(parseFloat(elements.rootBulkAmount?.value||"0")||0),n=String(elements.rootBulkReason?.value||"").trim(),a=String(elements.rootBulkTarget?.value||"all");if(!t||t<=0)return alert("í¬ì¸íŠ¸ ê°’ì„ 1 ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");if(!n)return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (í•„ìˆ˜)");const s="withdraw"===e?-t:t;if(!confirm(`ì „ì²´ ìœ ì €ì—ê²Œ ${s>=0?"+":""}${s}ptë¥¼ ì¼ê´„ ì ìš©í• ê¹Œìš”?\n\n- ëŒ€ìƒ: ${a}\n- ì‚¬ìœ : ${n}\n\nâ€» ë˜ëŒë¦¬ê¸° ì–´ë µìŠµë‹ˆë‹¤.`))return;const r=`bulk_${Date.now()}_${Math.random().toString(16).slice(2)}`,o=(new Date).toISOString();let i=0,l=0,c=null;const d=e=>{elements.rootBulkStatusText&&(elements.rootBulkStatusText.textContent=e)};d("ì§„í–‰ì¤‘...");try{for(;;){let e=db.collection(FIRESTORE_POINTS.userProfiles).orderBy("createdAt","asc").limit(150);c&&(e=e.startAfter(c));const t=await e.get();if(t.empty)break;const m=t.docs;c=m[m.length-1];for(const e of m){const t=e.data()||{},c=t.uid||e.id;if(!c){l++;continue}if("approved_only"===a&&!0!==t.pointsApproved){l++;continue}const{summaryRef:m,ledgerCol:u}=getPointsRefsForUser(c),p=u.doc(`ROOT_BULK_ADJUST__${r}`);await db.runTransaction(async e=>{const[a,i]=await Promise.all([e.get(p),e.get(m)]);if(a.exists)return;const l=i.exists&&i.data()||{},d=Number(l.balance)||0,u=Number(l.lifetimeEarned)||0,g=d+s,h=Math.max(0,u+s);e.set(p,{userId:c,userNickname:String(t.nickname||""),type:"ROOT_BULK_ADJUST",delta:s,refType:"root_bulk",refId:r,reasonText:n,adminNickname:currentUser.name||"ROOT",adminUserId:currentUser.uid,createdAt:o,kstDate:getKstDateKeyFromNow(),kstWeekKey:getIsoWeekKeyFromKstNow()}),e.set(m,{userId:c,userNickname:String(t.nickname||""),balance:g,lifetimeEarned:h,updatedAt:o},{merge:!0})}),i++,i%10==0&&d(`ì§„í–‰ì¤‘... ì²˜ë¦¬ ${i}ëª… / ì œì™¸ ${l}ëª…`)}}try{const e=db.collection(FIRESTORE_POINTS.publicAdminLog).doc(r);await e.set({type:"ROOT_BULK_ADJUST",delta:s,reasonText:n,adminNickname:currentUser.name||"ROOT",adminId:currentUser.uid,targetNickname:"approved_only"===a?"ì „ì²´(ìŠ¹ì¸ëœ ê³„ì •)":"ì „ì²´(ëª¨ë“  ê³„ì •)",targetUserId:null,processedCount:i,skippedCount:l,createdAt:o,kstDate:getKstDateKeyFromNow()},{merge:!0})}catch(e){console.warn("public log write failed:",e)}d(`ì™„ë£Œ: ì²˜ë¦¬ ${i}ëª… / ì œì™¸ ${l}ëª…`),showToast(`<i class="fa-solid fa-bolt"></i> ì¼ê´„ ì ìš© ì™„ë£Œ: ${i}ëª…`)}catch(e){console.error(e),d(`ì˜¤ë¥˜: ${formatFirestoreError(e)}`),alert("ì¼ê´„ ì ìš© ì‹¤íŒ¨:\n\n"+formatFirestoreError(e))}}async function adminAdjustPoints(){if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");if(!currentUser?.isAdmin)return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");const e=elements.adminAdjustTarget?.value?.trim()||"",t=parseInt(elements.adminAdjustDelta?.value||"0",10),n=elements.adminAdjustReason?.value?.trim()||"";if(!e)return alert("ëŒ€ìƒ ìœ ì € ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");if(!Number.isFinite(t)||0===t)return alert("í¬ì¸íŠ¸ ë³€ê²½ê°’ì„ ì…ë ¥í•˜ì„¸ìš”. (0 ì œì™¸)");if(!n)return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (í•„ìˆ˜)");const a=nicknameKey(e);if(!a)return alert("ë‹‰ë„¤ì„ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");const s=db.collection(FIRESTORE_POINTS.nicknameIndex).doc(a),r=await s.get().catch(()=>null),o=r?.exists&&r.data()?.uid||null;if(!o)return alert("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const i=`${Date.now()}_${Math.random().toString(16).slice(2)}`,l=(new Date).toISOString(),c=getKstDateKeyFromNow(),d=getIsoWeekKeyFromKstNow(),m=db.collection(FIRESTORE_POINTS.summary).doc(o),u=db.collection(FIRESTORE_POINTS.ledgerUsers).doc(o).collection("items").doc(`ADMIN_ADJUST__${i}`),p=db.collection(FIRESTORE_POINTS.publicAdminLog).doc(i);try{await db.runTransaction(async a=>{const[s,r,g]=await Promise.all([a.get(m),a.get(u),a.get(p)]);if(r.exists||g.exists)return;const h=s.exists?s.data():{},f=Number(h?.balance)||0,y=Number(h?.lifetimeEarned)||0,v=Math.max(0,y+t);a.set(u,{userId:o,userNickname:e,type:"ADMIN_ADJUST",delta:t,refType:"admin_adjust",refId:i,reasonText:n,adminNickname:currentUser.name,adminUserId:currentUser.uid,createdAt:l,kstDate:c,kstWeekKey:d}),a.set(p,{type:"ADMIN_ADJUST",delta:t,reasonText:n,adminNickname:currentUser.name,adminId:currentUser.uid,targetNickname:e,targetUserId:o,createdAt:l,kstDate:c}),a.set(m,{userId:o,userNickname:e,balance:f+t,lifetimeEarned:v,updatedAt:l},{merge:!0})}),showToast(`<i class="fa-solid fa-gavel"></i> ê´€ë¦¬ì ì¡°ì • ì™„ë£Œ (${t>=0?"+":""}${fmtInt(t)}pt)`),elements.adminAdjustReason.value="",elements.adminAdjustDelta.value="",await Promise.all([loadPointsPublicAdminLog(),refreshPointsHeader(),refreshPointsMePanel(),loadMyPointLedger()])}catch(e){console.error(e),alert("ê´€ë¦¬ì ì¡°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n"+formatFirestoreError(e))}}window.approvePointsForUser=async function(e){if(!db)return;if(!currentUser?.isAdmin)return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!e)return;if(!confirm(`ì´ ìœ ì €ì˜ í¬ì¸íŠ¸ ê¸°ëŠ¥ì„ ìŠ¹ì¸í• ê¹Œìš”?\n\nuid: ${e}`))return;const t=db.collection(FIRESTORE_POINTS.userProfiles).doc(e),n=firebase.firestore.FieldValue.serverTimestamp();try{await db.runTransaction(async a=>{const{summaryRef:s,stateRef:r}=getPointsRefsForUser(e),[o,i,l]=await Promise.all([a.get(t),a.get(s),a.get(r)]);if(!o.exists)throw new Error("í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.");const c=o.data()||{};if(!0===c.pointsApproved)return;a.set(t,{pointsApproved:!0,approvedAt:n,approvedBy:currentUser.uid},{merge:!0});const d=(new Date).toISOString(),m=String(c.nickname||"").trim();i.exists||a.set(s,{userId:e,userNickname:m,balance:0,lifetimeEarned:0,updatedAt:d}),l.exists||a.set(r,{userId:e,userNickname:m,lastCheckinKstDate:null,currentStreakDays:0,claimed3:!1,claimed7:!1,claimed14:!1,totalDraws:0,totalWins:0,gachaPity:0,updatedAt:d})}),showToast('<i class="fa-solid fa-check"></i> ìŠ¹ì¸ ì™„ë£Œ'),await Promise.all([loadPendingApprovals(),loadPointsPublicAdminLog()])}catch(e){console.error(e),alert("ìŠ¹ì¸ ì‹¤íŒ¨:\n\n"+formatFirestoreError(e))}};const firebaseConfig={apiKey:"AIzaSyCDqmgOsbXZu9FNkGCULDuEnu9ehSR2gbY",authDomain:"aion2rudra.firebaseapp.com",projectId:"aion2rudra",storageBucket:"aion2rudra.firebasestorage.app",messagingSenderId:"786371182560",appId:"1:786371182560:web:29dfdd720a9b369d2e7585"};let db,auth,functions;try{firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth(),functions=firebase.functions()}catch(e){console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨.",e)}let currentTab="all",posts=[],currentUser=null,currentEditingPostId=null;const unlockedPostIds=new Set;let isSubmittingPost=!1,isNoticeWritingMode=!1,isEditMode=!1,editingPostData=null,currentCalcData=null,lastSimulatedScore=null,lastSnapshotById=new Map,lastCharacterFetchError=null,autoAttendanceRanThisSession=!1,autoCharacterRefreshRanThisSession=!1;function getSessionId(){let e=sessionStorage.getItem("rudra_session_id");return e||(e=`${Date.now()}_${Math.random().toString(16).slice(2)}`,sessionStorage.setItem("rudra_session_id",e)),e}async function logAuditEvent(e,t={}){if(db)try{await db.collection("audit_logs").add({eventType:e,payload:t,createdAt:(new Date).toISOString(),actor:getDeleteActor()})}catch(e){console.error("audit ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:",e)}}async function sendLogToDiscord(e){if(DISCORD_LOG_WEBHOOK_URL)try{const t=Array.isArray(e)?e.join("\n"):String(e||"");if(!t.trim())return;await fetch(`${DISCORD_LOG_WEBHOOK_URL}?wait=false`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:t})})}catch(e){console.error("ë¡œê·¸ ì›¹í›… ì „ì†¡ ì‹¤íŒ¨:",e)}}async function sendGachaWinToDiscord(e){const t=getGachaWinWebhookUrl();if(t)try{const n=String(e||"").trim();if(!n)return;await fetch(`${t}?wait=false`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:n})})}catch(e){console.error("ë½‘ê¸° ë‹¹ì²¨ ì›¹í›… ì „ì†¡ ì‹¤íŒ¨:",e)}else console.warn("[gacha] win webhook not configured. set localStorage:","rudra_gacha_win_webhook_url")}function formatPostTypeLabel(e){return"party"===e?"ğŸ“¢ íŒŒí‹°ì› ëª¨ì§‘":"member"===e?"âš”ï¸ íŒŒí‹° êµ¬ì§":"notice"===e?"ğŸ”” ê³µì§€ì‚¬í•­":"ğŸ“ ê²Œì‹œê¸€"}function formatKst(e){try{const t=e instanceof Date?e:new Date(e);return!t||Number.isNaN(t.getTime())?null:new Intl.DateTimeFormat("ko-KR",{timeZone:"Asia/Seoul",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(t)}catch{return null}}function getHardDeleteNotifyCache(){try{return JSON.parse(sessionStorage.getItem("rudra_hard_delete_notified")||"{}")}catch{return{}}}function setHardDeleteNotified(e){try{const t=getHardDeleteNotifyCache();t[e]=Date.now(),sessionStorage.setItem("rudra_hard_delete_notified",JSON.stringify(t))}catch{}}function shouldNotifyHardDelete(e){if(!e)return!1;return!getHardDeleteNotifyCache()[e]}async function notifyDeletionToDiscord(e,t,n){const a=e||{},s=a.title||"(ì œëª© ì—†ìŒ)",r=a.author?.name?`${a.author.name}${a.author?.class?` (${a.author.class})`:""}`:"(ì‘ì„±ì ì •ë³´ ì—†ìŒ)",o=a.createdAt||null,i=a.id||a.postId||null,l=(new Date).toISOString(),c=formatKst(l),d=o?formatKst(o):null,m=a.deletedAt||null,u=m?formatKst(m):null,p=["â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”","ğŸ—‘ï¸ **ê²Œì‹œê¸€ ì‚­ì œ/ì •ë¦¬ ê°ì§€**",`- **ê°ì§€ì‹œê°(KST)**: ${c||""}`,`- **ê°ì§€ì‹œê°(ISO)**: ${l}`,"",`- **ìœ í˜•**: ${formatPostTypeLabel(a.type)}`,`- **ì œëª©**: ${s}`,`- **ì‘ì„±ì**: ${r}`,d?`- **ì‘ì„±ì‹œê°„(KST)**: ${d}`:null,o?`- **ì‘ì„±ì‹œê°„(ISO)**: ${o}`:null,i?`- **postId**: ${i}`:null,`- **appVersion**: ${APP_VERSION}`,"",`- **ì‚¬ìœ ì½”ë“œ**: ${t||"unknown"}`,`- **ì‚¬ìœ **: ${n||""}`,u?`- **ì‚­ì œì²˜ë¦¬ì‹œê°(KST)**: ${u}`:null,m?`- **ì‚­ì œì²˜ë¦¬ì‹œê°(ISO)**: ${m}`:null,a.deletedSource?`- **ì‚­ì œê²½ë¡œ**: ${a.deletedSource}`:null,"",`- **ê°ì§€ì(í˜„ì¬ ì„¸ì…˜)**: ${currentUser?.name||"unknown"}${currentUser?.isAdmin?" (admin)":""}`,"â€» hard_delete_detectedì˜ â€œê°ì§€ìâ€ëŠ” ì‚­ì œ ì‹¤í–‰ìê°€ ì•„ë‹ˆë¼, ì‚¬ë¼ì§ì„ ê°ì§€í•œ ì‚¬ìš©ìì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.","â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"].filter(Boolean);await sendLogToDiscord(p)}function getDeleteActor(){return{at:(new Date).toISOString(),by:currentUser?.name||null,isAdmin:!!currentUser?.isAdmin,authProvider:currentUser?.adminAuth?.provider||null,discordUserId:currentUser?.adminAuth?.discordUserId||null,userAgent:navigator.userAgent,page:location.href,appVersion:APP_VERSION,sessionId:getSessionId()}}function canManagePost(e){return!!e&&(!!currentUser&&(!!currentUser.isAdmin||(!(!currentUser.uid||!e.authorUid||currentUser.uid!==e.authorUid)||currentUser.name&&e.author&&currentUser.name===e.author.name)))}async function softDeletePostById(e,t,n,a=null){if(!db||!e)return;const s={deletedAt:(new Date).toISOString(),deletedReasonCode:t||"unknown",deletedReason:n||"",deletedSource:a||null,deletedActor:getDeleteActor(),status:"deleted"};await db.collection("posts").doc(e).update(s)}function normalizeScoreInfoStats(e){const t=e?.scoreInfo?.stats?.stats;if(!Array.isArray(t))return null;const n={};t.forEach(e=>{e&&"object"==typeof e&&e.id&&(n[e.id]=e.value||e.percent||null,n[`${e.id}__raw`]=e)});const a=e=>{const t=n[`${e}__raw`],a=t?.value?.percent??t?.percent;return Number.isFinite(a)?a:0},s=e=>{const t=n[`${e}__raw`],a=t?.value?.value??t?.value;return Number.isFinite(a)?a:0};return{attackPower:s("attackPower"),combatSpeed:a("combatSpeed"),weaponDamageAmp:a("weaponDamage"),damageAmp:a("damage"),criticalDamageAmp:a("criticalDamage"),cooldownReduction:a("cooldown"),stunHit:a("powerStrike"),perfect:a("perfection"),multiHit:a("multiHit"),criticalHit:s("critical")}}function extractWeaponMinMaxFromItemDetails(e){const t=e?.itemDetails;if(!Array.isArray(t))return{weaponMinAttack:0,weaponMaxAttack:0};for(const e of t){const t=e?.mainStats;if(Array.isArray(t))for(const e of t)if("WeaponFixingDamage"===e?.id){return{weaponMinAttack:Number.isFinite(e?.minValue)?e.minValue:0,weaponMaxAttack:Number.isFinite(e?.maxValue)?e.maxValue:0}}}return{weaponMinAttack:0,weaponMaxAttack:0}}const categoryData={"ì •ë³µ":{details:["í¬ë¼ì˜¤ ë™êµ´","ë“œë¼ì›ë‹ˆë¥´","ìš°ë£¨êµ¬êµ¬ í˜‘ê³¡","ë°”í¬ë¡ ì˜ ê³µì¤‘ì„¬","ë¶ˆì˜ ì‹ ì „","ì‚¬ë‚˜ìš´ ë¿” ì•”êµ´"],difficulties:["ë³´í†µ","ì–´ë ¤ì›€"]},"ì„±ì—­":{details:["1ë„´","2ë„´","ë¬´ê´€"],difficulties:[]},"ì´ˆì›”":{details:["ë°ìš°ìŠ¤ ì—°êµ¬ê¸°ì§€","ì¡°ê°ë‚œ ì•„ë¥´ì¹´ë‹ˆìŠ¤"],difficulties:["1ë‹¨ê³„","2ë‹¨ê³„","3ë‹¨ê³„","4ë‹¨ê³„","5ë‹¨ê³„","6ë‹¨ê³„","7ë‹¨ê³„","8ë‹¨ê³„","9ë‹¨ê³„","10ë‹¨ê³„"]},"í† ë²Œì „":{details:["í† ë²Œì „"],difficulties:["ì‰¬ì›€","ë³´í†µ","ì–´ë ¤ì›€"]},"PVE (ë‹¥ì‚¬)":{details:["í•„ë“œ","ì–´ë¹„ìŠ¤"],difficulties:[]},PVP:{details:["ì‹œê³µ, ì–´ë¹„ìŠ¤"],difficulties:[]}},elements={postList:document.getElementById("postList"),noticeList:document.getElementById("noticeList"),loadMoreNoticeBtn:document.getElementById("loadMoreNoticeBtn"),writeBtn:document.getElementById("writeBtn"),writeNoticeBtn:document.getElementById("writeNoticeBtn"),tabBtns:document.querySelectorAll(".tab-btn"),roleFilter:document.getElementById("roleFilter"),categoryFilter:document.getElementById("categoryFilter"),modals:document.querySelectorAll(".modal"),writeModal:document.getElementById("writeModal"),modalTitle:document.getElementById("modalTitle"),writeCloseBtn:document.querySelector(".write-close"),postForm:document.getElementById("postForm"),postCategory:document.getElementById("postCategory"),detailSelectGroup:document.getElementById("detailSelectGroup"),postDetail:document.getElementById("postDetail"),postDifficulty:document.getElementById("postDifficulty"),postRoleCheckboxes:document.querySelectorAll('input[name="postRole"]'),postMyDps:document.getElementById("postMyDps"),postExpiration:document.getElementById("postExpiration"),postTitle:document.getElementById("postTitle"),postContent:document.getElementById("postContent"),postLink:document.getElementById("postLink"),submitPostBtn:document.getElementById("submitPostBtn"),noticeMessage:document.getElementById("noticeMessage"),categoryGroup:document.getElementById("categoryGroup"),roleGroup:document.getElementById("roleGroup"),linkGroup:document.getElementById("linkGroup"),dpsGroup:document.getElementById("dpsGroup"),expirationGroup:document.getElementById("expirationGroup"),guestNameGroup:document.getElementById("guestNameGroup"),guestPasswordGroup:document.getElementById("guestPasswordGroup"),postGuestName:document.getElementById("postGuestName"),postGuestPassword:document.getElementById("postGuestPassword"),authModal:document.getElementById("authModal"),authCloseBtn:document.querySelector(".auth-close"),authForm:document.getElementById("authForm"),authModalTitle:document.getElementById("authModalTitle"),authHelpText:document.getElementById("authHelpText"),authTabLogin:document.getElementById("authTabLogin"),authTabSignup:document.getElementById("authTabSignup"),authLoginId:document.getElementById("authLoginId"),authPassword:document.getElementById("authPassword"),authPasswordConfirm:document.getElementById("authPasswordConfirm"),authRememberMe:document.getElementById("authRememberMe"),authPasswordConfirmGroup:document.getElementById("authPasswordConfirmGroup"),loginBtn:document.getElementById("loginBtn"),userInfo:document.getElementById("userInfo"),userNickname:document.getElementById("userNickname"),logoutBtn:document.getElementById("logoutBtn"),adminVerifyBtn:document.getElementById("adminVerifyBtn"),adminBadge:document.getElementById("adminBadge"),rootBadge:document.getElementById("rootBadge"),adminToolsBtn:document.getElementById("adminToolsBtn"),authNickname:document.getElementById("authNickname"),authNicknameGroup:document.getElementById("authNicknameGroup"),authSubmitBtn:document.getElementById("authSubmitBtn"),manageModal:document.getElementById("manageModal"),manageCloseBtn:document.querySelector(".manage-close"),managePostInfo:document.getElementById("managePostInfo"),managePostTitle:document.getElementById("managePostTitle"),managePostContent:document.getElementById("managePostContent"),managePostSaveBtn:document.getElementById("managePostSaveBtn"),btnStatusRecruiting:document.getElementById("btnStatusRecruiting"),btnStatusFull:document.getElementById("btnStatusFull"),newMemberName:document.getElementById("newMemberName"),newMemberClass:document.getElementById("newMemberClass"),addMemberBtn:document.getElementById("addMemberBtn"),partyMemberList:document.getElementById("partyMemberList"),deletePostBtn:document.getElementById("deletePostBtn"),detailModal:document.getElementById("detailModal"),detailCloseBtn:document.querySelector(".detail-close"),detailCategoryBadge:document.getElementById("detailCategoryBadge"),detailRoles:document.getElementById("detailRoles"),detailTitle:document.getElementById("detailTitle"),detailAuthor:document.getElementById("detailAuthor"),detailTime:document.getElementById("detailTime"),detailContent:document.getElementById("detailContent"),detailLink:document.getElementById("detailLink"),detailAuthorProfile:document.getElementById("detailAuthorProfile"),detailPartySection:document.getElementById("detailPartySection"),detailPartyListContainer:document.getElementById("detailPartyListContainer"),guideBtn:document.getElementById("guideBtn"),guideModal:document.getElementById("guideModal"),guideCloseBtn:document.querySelector(".guide-close"),toastContainer:document.getElementById("toastContainer"),headerSearchInput:document.getElementById("headerSearchInput"),headerSearchBtn:document.getElementById("headerSearchBtn"),searchResultModal:document.getElementById("searchResultModal"),searchCloseBtn:document.querySelector(".search-close"),searchResultContent:document.getElementById("searchResultContent"),openCalculatorBtn:document.getElementById("openCalculatorBtn"),dpsCalculatorModal:document.getElementById("dpsCalculatorModal"),calcCloseBtn:document.querySelector(".calc-close"),doCalculateBtn:document.getElementById("doCalculateBtn"),calcAttackPower:document.getElementById("calcAttackPower"),calcWeaponMin:document.getElementById("calcWeaponMin"),calcWeaponMax:document.getElementById("calcWeaponMax"),calcCritStat:document.getElementById("calcCritStat"),calcCombatSpeed:document.getElementById("calcCombatSpeed"),calcWeaponDamageAmp:document.getElementById("calcWeaponDamageAmp"),calcDamageAmp:document.getElementById("calcDamageAmp"),calcCritDamageAmp:document.getElementById("calcCritDamageAmp"),calcSkillDamage:document.getElementById("calcSkillDamage"),calcCooldownReduction:document.getElementById("calcCooldownReduction"),calcStunHit:document.getElementById("calcStunHit"),calcPerfect:document.getElementById("calcPerfect"),calcMultiHit:document.getElementById("calcMultiHit"),calcResultScore:document.getElementById("calcResultScore"),calcDiff:document.getElementById("calcDiff"),calcAtulBtn:document.getElementById("calcAtulBtn"),calcTargetScore:document.getElementById("calcTargetScore"),doRecommendBtn:document.getElementById("doRecommendBtn"),calcRecommendOutput:document.getElementById("calcRecommendOutput"),adminToolsModal:document.getElementById("adminToolsModal"),adminToolsCloseBtn:document.querySelector(".admin-tools-close"),adminTabBtns:document.querySelectorAll(".admin-tab-btn"),adminTabAudit:document.getElementById("adminTabAudit"),adminTabBackup:document.getElementById("adminTabBackup"),auditList:document.getElementById("auditList"),auditTypeFilter:document.getElementById("auditTypeFilter"),auditSearch:document.getElementById("auditSearch"),auditReloadBtn:document.getElementById("auditReloadBtn"),exportPostsBtn:document.getElementById("exportPostsBtn"),exportNoticesBtn:document.getElementById("exportNoticesBtn"),exportPostsIncludeDeletedBtn:document.getElementById("exportPostsIncludeDeletedBtn"),restoreList:document.getElementById("restoreList"),restoreSearch:document.getElementById("restoreSearch"),restoreReloadBtn:document.getElementById("restoreReloadBtn"),importJsonText:document.getElementById("importJsonText"),importMode:document.getElementById("importMode"),importBtn:document.getElementById("importBtn"),clearImportBtn:document.getElementById("clearImportBtn"),pointsOpenBtn:document.getElementById("pointsOpenBtn"),pointsBalanceText:document.getElementById("pointsBalanceText"),pointsModal:document.getElementById("pointsModal"),pointsCloseBtn:document.querySelector(".points-close"),pointsHowtoBtn:document.getElementById("pointsHowtoBtn"),pointsHowtoPanel:document.getElementById("pointsHowtoPanel"),pointsTabBtns:document.querySelectorAll(".points-tab-btn"),pointsAdminTabBtn:document.getElementById("pointsAdminTabBtn"),pointsEventTabBtn:document.getElementById("pointsEventTabBtn"),pointsTabMe:document.getElementById("pointsTabMe"),pointsTabGacha:document.getElementById("pointsTabGacha"),pointsTabEvent:document.getElementById("pointsTabEvent"),pointsTabRanking:document.getElementById("pointsTabRanking"),pointsTabPublicLog:document.getElementById("pointsTabPublicLog"),pointsTabAdmin:document.getElementById("pointsTabAdmin"),pointsMeBalance:document.getElementById("pointsMeBalance"),pointsMeLifetime:document.getElementById("pointsMeLifetime"),pointsLedgerList:document.getElementById("pointsLedgerList"),attendanceBtn:document.getElementById("attendanceBtn"),pointsRefreshBtn:document.getElementById("pointsRefreshBtn"),streakToday:document.getElementById("streakToday"),streakDays:document.getElementById("streakDays"),streakNext:document.getElementById("streakNext"),streakBar:document.getElementById("streakBar"),streakHint:document.getElementById("streakHint"),gachaTotalDraws:document.getElementById("gachaTotalDraws"),gachaEventBadge:document.getElementById("gachaEventBadge"),gachaCostText:document.getElementById("gachaCostText"),gachaRoundText:document.getElementById("gachaRoundText"),gachaWinnersText:document.getElementById("gachaWinnersText"),gachaDrawBtn:document.getElementById("gachaDrawBtn"),gachaRefreshBtn:document.getElementById("gachaRefreshBtn"),gachaRollStage:document.getElementById("gachaRollStage"),gachaRollText:document.getElementById("gachaRollText"),gachaResult:document.getElementById("gachaResult"),gachaWinnersList:document.getElementById("gachaWinnersList"),pointsRankingList:document.getElementById("pointsRankingList"),pointsPublicAdminLogList:document.getElementById("pointsPublicAdminLogList"),adminAdjustTarget:document.getElementById("adminAdjustTarget"),adminAdjustDelta:document.getElementById("adminAdjustDelta"),adminAdjustReason:document.getElementById("adminAdjustReason"),adminAdjustSubmitBtn:document.getElementById("adminAdjustSubmitBtn"),pendingApprovalsReloadBtn:document.getElementById("pendingApprovalsReloadBtn"),pendingApprovalsList:document.getElementById("pendingApprovalsList"),rootEventCard:document.getElementById("rootEventCard"),rootGachaControlCard:document.getElementById("rootGachaControlCard"),saveGachaControlBtn:document.getElementById("saveGachaControlBtn"),gachaControlStatusText:document.getElementById("gachaControlStatusText"),rootBulkPointsCard:document.getElementById("rootBulkPointsCard"),rootBulkMode:document.getElementById("rootBulkMode"),rootBulkAmount:document.getElementById("rootBulkAmount"),rootBulkReason:document.getElementById("rootBulkReason"),rootBulkTarget:document.getElementById("rootBulkTarget"),rootBulkApplyBtn:document.getElementById("rootBulkApplyBtn"),rootBulkStatusText:document.getElementById("rootBulkStatusText"),gachaEventEnabled:document.getElementById("gachaEventEnabled"),gachaEventStartKst:document.getElementById("gachaEventStartKst"),gachaEventEndKst:document.getElementById("gachaEventEndKst"),gachaEventMultiplier:document.getElementById("gachaEventMultiplier"),gachaEventCostOverride:document.getElementById("gachaEventCostOverride"),gachaEventMessage:document.getElementById("gachaEventMessage"),gachaEnabled:document.getElementById("gachaEnabled"),gachaRoundNo:document.getElementById("gachaRoundNo"),gachaMaxWinners:document.getElementById("gachaMaxWinners"),saveGachaEventBtn:document.getElementById("saveGachaEventBtn"),gachaEventStatusText:document.getElementById("gachaEventStatusText"),eventPublicBox:document.getElementById("eventPublicBox")};function setupRealtimeListener(){db&&db.collection("posts").orderBy("createdAt","desc").onSnapshot(e=>{const t=new Map;e.forEach(e=>{t.set(e.id,e.data())});for(const[e,n]of lastSnapshotById.entries())t.has(e)||(logAuditEvent("hard_delete_detected",{postId:e,previousData:n||null}),shouldNotifyHardDelete(e)&&(setHardDeleteNotified(e),notifyDeletionToDiscord({...n||{},postId:e},"hard_delete_detected","ë¬¸ì„œê°€ í•˜ë“œ ì‚­ì œë˜ì–´ ìŠ¤ëƒ…ìƒ·ì—ì„œ ì‚¬ë¼ì§")));lastSnapshotById=t,posts=[],e.forEach(e=>{posts.push({id:e.id,...e.data()})}),checkExpiredPosts(),renderPosts(),renderNotices()},e=>{console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:",e),logAuditEvent("realtime_listener_error",{code:e?.code||null,message:e?.message||String(e)}),sendLogToDiscord(["âš ï¸ **Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜**","",`- **code**: ${e?.code||""}`,`- **message**: ${e?.message||String(e)}`])})}function setupEventListeners(){if(elements.tabBtns.forEach(e=>{e.addEventListener("click",()=>{elements.tabBtns.forEach(e=>e.classList.remove("active")),e.classList.add("active"),currentTab=e.dataset.tab,renderPosts()})}),elements.roleFilter&&elements.roleFilter.addEventListener("change",renderPosts),elements.categoryFilter&&elements.categoryFilter.addEventListener("change",renderPosts),elements.loginBtn.addEventListener("click",()=>{setAuthMode("login"),elements.authModal.classList.remove("hidden")}),elements.authCloseBtn.addEventListener("click",()=>{elements.authModal.classList.add("hidden")}),elements.authTabLogin&&elements.authTabLogin.addEventListener("click",()=>setAuthMode("login")),elements.authTabSignup&&elements.authTabSignup.addEventListener("click",()=>setAuthMode("signup")),elements.authForm.addEventListener("submit",async e=>{e.preventDefault(),await submitAuthForm()}),elements.logoutBtn.addEventListener("click",logout),elements.adminToolsBtn&&elements.adminToolsBtn.addEventListener("click",openAdminToolsModal),elements.adminToolsCloseBtn&&elements.adminToolsCloseBtn.addEventListener("click",closeAdminToolsModal),elements.pointsOpenBtn&&elements.pointsOpenBtn.addEventListener("click",openPointsModal),elements.pointsCloseBtn&&elements.pointsCloseBtn.addEventListener("click",closePointsModal),elements.pointsHowtoBtn&&elements.pointsHowtoPanel&&elements.pointsHowtoBtn.addEventListener("click",()=>{elements.pointsHowtoPanel.classList.toggle("hidden")}),elements.pointsTabBtns&&elements.pointsTabBtns.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.pointsTab;t&&switchPointsTab(t)})}),elements.pointsRefreshBtn&&elements.pointsRefreshBtn.addEventListener("click",()=>refreshPointsAll({showToastOnDone:!0})),elements.attendanceBtn&&elements.attendanceBtn.addEventListener("click",doAttendanceCheck),elements.gachaDrawBtn&&elements.gachaDrawBtn.addEventListener("click",doGachaDraw),elements.gachaRefreshBtn&&elements.gachaRefreshBtn.addEventListener("click",()=>refreshGachaPanel({showToastOnDone:!0})),elements.adminAdjustSubmitBtn&&elements.adminAdjustSubmitBtn.addEventListener("click",adminAdjustPoints),elements.pendingApprovalsReloadBtn&&elements.pendingApprovalsReloadBtn.addEventListener("click",loadPendingApprovals),elements.saveGachaControlBtn&&elements.saveGachaControlBtn.addEventListener("click",saveGachaControlConfig),elements.saveGachaEventBtn&&elements.saveGachaEventBtn.addEventListener("click",saveGachaEventConfig),elements.rootBulkApplyBtn&&elements.rootBulkApplyBtn.addEventListener("click",rootBulkAdjustAllUsers),elements.adminTabBtns&&elements.adminTabBtns.forEach(e=>{e.addEventListener("click",()=>{elements.adminTabBtns.forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.adminTab;elements.adminTabAudit.classList.toggle("hidden","audit"!==t),elements.adminTabBackup.classList.toggle("hidden","backup"!==t)})}),elements.auditReloadBtn&&elements.auditReloadBtn.addEventListener("click",loadAuditLogs),elements.auditTypeFilter&&elements.auditTypeFilter.addEventListener("change",renderAuditLogs),elements.auditSearch&&elements.auditSearch.addEventListener("input",renderAuditLogs),elements.restoreReloadBtn&&elements.restoreReloadBtn.addEventListener("click",renderRestoreList),elements.restoreSearch&&elements.restoreSearch.addEventListener("input",renderRestoreList),elements.exportPostsBtn&&elements.exportPostsBtn.addEventListener("click",()=>exportPostsJson({includeDeleted:!1,onlyNotices:!1})),elements.exportNoticesBtn&&elements.exportNoticesBtn.addEventListener("click",()=>exportPostsJson({includeDeleted:!1,onlyNotices:!0})),elements.exportPostsIncludeDeletedBtn&&elements.exportPostsIncludeDeletedBtn.addEventListener("click",()=>exportPostsJson({includeDeleted:!0,onlyNotices:!1})),elements.importBtn&&elements.importBtn.addEventListener("click",importPostsJson),elements.clearImportBtn&&elements.clearImportBtn.addEventListener("click",()=>{elements.importJsonText&&(elements.importJsonText.value="")}),elements.writeBtn&&elements.writeBtn.addEventListener("click",()=>{openWriteModal(!1)}),elements.writeNoticeBtn&&elements.writeNoticeBtn.addEventListener("click",()=>{openWriteModal(!0)}),elements.writeCloseBtn&&elements.writeCloseBtn.addEventListener("click",()=>{elements.writeModal.classList.add("hidden")}),elements.postCategory&&elements.detailSelectGroup&&elements.postDetail&&elements.postDifficulty&&elements.postCategory.addEventListener("change",e=>{const t=e.target.value,n=categoryData[t];n?(elements.detailSelectGroup.classList.remove("hidden"),elements.postDetail.innerHTML="",n.details.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,elements.postDetail.appendChild(t)}),elements.postDifficulty.innerHTML="",n.difficulties.length>0?(elements.postDifficulty.style.display="block",n.difficulties.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,elements.postDifficulty.appendChild(t)})):elements.postDifficulty.style.display="none"):elements.detailSelectGroup.classList.add("hidden")}),elements.postRoleCheckboxes&&elements.postRoleCheckboxes.length){const e=document.getElementById("role_any"),t=Array.from(elements.postRoleCheckboxes).filter(e=>"ë¬´ê´€"!==e.value);e&&e.addEventListener("change",()=>{e.checked&&t.forEach(e=>e.checked=!1)}),t.forEach(t=>{t.addEventListener("change",()=>{t.checked&&e&&(e.checked=!1)})})}elements.postForm&&elements.postForm.addEventListener("submit",handlePostSubmit),elements.manageCloseBtn&&elements.manageCloseBtn.addEventListener("click",()=>{elements.manageModal.classList.add("hidden"),currentEditingPostId=null}),elements.btnStatusRecruiting&&elements.btnStatusRecruiting.addEventListener("click",()=>updatePostStatus("recruiting")),elements.btnStatusFull&&elements.btnStatusFull.addEventListener("click",()=>updatePostStatus("full")),elements.addMemberBtn&&elements.addMemberBtn.addEventListener("click",addPartyMember),elements.deletePostBtn&&elements.deletePostBtn.addEventListener("click",deletePost),elements.managePostSaveBtn&&elements.managePostSaveBtn.addEventListener("click",saveManagedPostEdits),elements.detailCloseBtn.addEventListener("click",()=>{elements.detailModal.classList.add("hidden")}),elements.guideBtn.addEventListener("click",()=>{elements.guideModal.classList.remove("hidden")}),elements.guideCloseBtn.addEventListener("click",()=>{elements.guideModal.classList.add("hidden")}),elements.loadMoreNoticeBtn.addEventListener("click",()=>{renderNotices(!0),elements.loadMoreNoticeBtn.classList.add("hidden")}),elements.headerSearchBtn.addEventListener("click",handleHeaderSearch),elements.headerSearchInput.addEventListener("keypress",e=>{"Enter"===e.key&&handleHeaderSearch()}),elements.searchCloseBtn.addEventListener("click",()=>{elements.searchResultModal.classList.add("hidden")}),elements.openCalculatorBtn&&elements.openCalculatorBtn.addEventListener("click",()=>{lastSimulatedScore=null,elements.calcDiff&&(elements.calcDiff.textContent="(0)",elements.calcDiff.style.color="var(--text-muted)"),currentCalcData&&fillCalculator(currentCalcData),elements.dpsCalculatorModal.classList.remove("hidden")}),elements.calcCloseBtn&&elements.calcCloseBtn.addEventListener("click",()=>{elements.dpsCalculatorModal.classList.add("hidden")}),elements.doCalculateBtn&&elements.doCalculateBtn.addEventListener("click",calculateEstimatedDps),elements.doRecommendBtn&&elements.doRecommendBtn.addEventListener("click",recommendStatsForTargetScore),elements.calcAtulBtn&&elements.calcAtulBtn.addEventListener("click",()=>{currentCalcData?.name?openAtulPage(currentCalcData.name):alert("ë¨¼ì € ìºë¦­í„°ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.")}),window.addEventListener("click",e=>{if(e.target.classList.contains("modal")){if("writeModal"===e.target.id)return;if("dpsCalculatorModal"===e.target.id)return;if("searchResultModal"===e.target.id)return;if("pointsModal"===e.target.id)return;e.target.classList.add("hidden")}}),setupGlobalTooltips()}function setupGlobalTooltips(){let e=document.getElementById("globalTooltip");e||(e=document.createElement("div"),e.id="globalTooltip",e.className="global-tooltip",document.body.appendChild(e));document.querySelectorAll(".tooltip-icon[data-tooltip]").forEach(t=>{t.addEventListener("mouseenter",()=>{const n=t.getAttribute("data-tooltip")||"";if(!n)return;e.textContent=n,e.classList.add("show");const a=t.getBoundingClientRect(),s=e.getBoundingClientRect();let r=a.left+a.width/2-s.width/2,o=a.top-s.height-10;r=Math.max(12,Math.min(r,window.innerWidth-s.width-12)),o<12&&(o=a.bottom+10),e.style.transform=`translate(${Math.round(r)}px, ${Math.round(o)}px)`}),t.addEventListener("mouseleave",()=>{e.classList.remove("show"),e.style.transform="translate(-9999px, -9999px)"})})}async function handleHeaderSearch(){const e=elements.headerSearchInput.value.trim();if(!e)return void alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");const t=elements.headerSearchBtn.innerHTML;elements.headerSearchBtn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',elements.headerSearchBtn.disabled=!0;try{lastCharacterFetchError=null;const t=await fetchCharacterData(e);currentCalcData=t,t?(elements.searchResultContent.innerHTML=`\n                <div class="search-profile">\n                    <img src="${avatarUrlFromCharKeyOrFallback(t.charId,t.profile_img,t.name)}" class="search-avatar">\n                    <div class="search-name">${t.name}</div>\n                    <div class="search-class">${t.class} (Lv.${t.level})</div>\n                </div>\n                \n                <div class="score-box-container">\n                    <div class="score-box">\n                        <div class="score-label">ì•„ì˜¨ ì ìˆ˜</div>\n                        <div class="score-value">${Math.floor(t.aonScore||0).toLocaleString()}</div>\n                    </div>\n                    <div class="score-box">\n                        <div class="score-label">ì•„íˆ´ ì „íˆ¬ë ¥</div>\n                        <div class="score-value">${(t.combatScore||0).toLocaleString()}</div>\n                        <div class="score-sub">â€» ì‹¤ì œ ì•„íˆ´ê³¼<p> ìƒì´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>\n                    </div>\n                </div>\n\n                <div style="margin-top:20px; text-align:center;">\n                     <button class="btn-outline full-width" onclick="window.open('https://www.aion2tool.com/char/serverid=2002/${encodeURIComponent(e)}', '_blank')">\n                        <i class="fa-solid fa-arrow-up-right-from-square"></i> ì•„íˆ´ì—ì„œ ìì„¸íˆ ë³´ê¸°\n                     </button>\n                </div>\n            `,elements.searchResultModal.classList.remove("hidden"),elements.openCalculatorBtn.classList.remove("hidden")):(lastCharacterFetchError?alert("ìºë¦­í„° ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n"+lastCharacterFetchError):alert("ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),elements.openCalculatorBtn.classList.add("hidden"))}catch(e){console.error(e),alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n"+(e?.message||String(e)))}finally{elements.headerSearchBtn.innerHTML=t,elements.headerSearchBtn.disabled=!1,elements.headerSearchInput.value=""}}function fillCalculator(e){if(!e)return;const t=e.calcStats;t?(elements.calcAttackPower.value=t.attackPower||0,elements.calcWeaponMin.value=t.weaponMinAttack||0,elements.calcWeaponMax.value=t.weaponMaxAttack||0,elements.calcCritStat.value=t.criticalHit||0,elements.calcCombatSpeed.value=t.combatSpeed||0,elements.calcWeaponDamageAmp.value=t.weaponDamageAmp||0,elements.calcDamageAmp.value=t.damageAmp||0,elements.calcCritDamageAmp.value=t.criticalDamageAmp||0,elements.calcSkillDamage.value=t.skillDamage||0,elements.calcCooldownReduction.value=t.cooldownReduction||0,elements.calcStunHit.value=t.stunHit||0,elements.calcPerfect.value=t.perfect||0,elements.calcMultiHit.value=t.multiHit||0,calculateEstimatedDps()):showToast('<i class="fa-solid fa-circle-info"></i> AON APIì—ì„œ ì„¸ë¶€ ìŠ¤íƒ¯ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ í•  ìˆ˜ ì—†ì–´, ì§ì ‘ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.')}function convertCritStatToChance(e){return.7*e/10}function clampPercent(e,t=100){const n=Number(e);return Number.isFinite(n)?Math.min(Math.max(n,0),t):0}function escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function defaultAvatarDataUri(e="A"){const t=String(e||"A").trim().slice(0,1).toUpperCase()||"A";return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#8b5cf6"/><stop offset="1" stop-color="#22c55e"/></linearGradient></defs><rect width="128" height="128" rx="64" fill="url(#g)"/><text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle" font-family="Cafe24Ssurround, Pretendard, sans-serif" font-size="56" fill="rgba(255,255,255,0.92)">${t}</text></svg>`)}`}function safeAvatarUrl(e,t="A"){const n=String(e||"").trim();return n&&(n.startsWith("http://")||n.startsWith("https://")||n.startsWith("data:"))?n:defaultAvatarDataUri(t)}function ingameAvatarUrl(e,t=2002){const n=String(e||"").trim();return n&&/^\d+$/.test(n)?`https://profileimg.plaync.com/game_profile_images/aion2/images?gameServerKey=${encodeURIComponent(String(t))}&charKey=${encodeURIComponent(n)}`:""}function avatarUrlFromCharKeyOrFallback(e,t,n="A"){const a=ingameAvatarUrl(e);return a||safeAvatarUrl(t,n)}function extractCharKey(e){if(!e)return null;const t=[e.charKey,e.characterKey,e.characterKeyNo,e.characterId,e.id];for(const e of t){const t=String(e||"").trim();if(t&&/^\d+$/.test(t))return t}return null}function aon2KeyFromTimestamp(e){const t=String(e||"");return t.length<16?t.padEnd(16,"0"):t.length>16?t.slice(0,16):t}function base64ToBytes(e){let t=String(e||"").trim();if(!t)return new Uint8Array;t=t.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;n&&(t+="=".repeat(4-n));const a=atob(t),s=new Uint8Array(a.length);for(let e=0;e<a.length;e++)s[e]=a.charCodeAt(e);return s}function pkcs7Unpad(e){if(!e||!e.length)return e;const t=e[e.length-1];return!t||t>16?e:e.slice(0,e.length-t)}async function decryptAon2InfoPayload(e,t){const n=aon2KeyFromTimestamp(t),a=(new TextEncoder).encode(n),s=(new TextEncoder).encode(n.slice(0,16)),r=base64ToBytes(e),o=await crypto.subtle.importKey("raw",a,{name:"AES-CBC"},!1,["decrypt"]),i=pkcs7Unpad(new Uint8Array(await crypto.subtle.decrypt({name:"AES-CBC",iv:s},o,r)));return(new TextDecoder).decode(i)}async function decodeAon2PayloadIfNeeded(e){if(!e)return null;if("string"==typeof e?.data&&e?.timestamp)try{const t=await decryptAon2InfoPayload(e.data,e.timestamp);return JSON.parse(t)}catch(e){return lastCharacterFetchError=`ë³µí˜¸í™” ì‹¤íŒ¨: ${e?.message||String(e)}`,null}return e}document.addEventListener("DOMContentLoaded",()=>{initAuth(),setupRealtimeListener(),setupEventListeners(),setInterval(()=>{try{checkExpiredPosts()}catch(e){console.error(e)}},6e4)});let auditUnsub=null,auditCache=[];function openAdminToolsModal(){currentUser?.isAdmin?elements.adminToolsModal&&(elements.adminToolsModal.classList.remove("hidden"),loadAuditLogs(),renderRestoreList()):alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.")}function closeAdminToolsModal(){elements.adminToolsModal&&(elements.adminToolsModal.classList.add("hidden"),auditUnsub&&(auditUnsub(),auditUnsub=null))}function renderRestoreList(){if(!elements.restoreList)return;if(!currentUser?.isAdmin)return void(elements.restoreList.innerHTML='<div style="color: var(--text-sub); padding: 12px;">ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>');const e=(elements.restoreSearch?.value||"").trim().toLowerCase();let t=posts.filter(e=>e&&e.deletedAt&&"notice"!==e.type).concat(posts.filter(e=>e&&e.deletedAt&&"notice"===e.type)).sort((e,t)=>new Date(t.deletedAt).getTime()-new Date(e.deletedAt).getTime());if(e&&(t=t.filter(t=>`${t.id||""} ${t.title||""} ${t.author?.name||""} ${t.deletedReasonCode||""}`.toLowerCase().includes(e))),!t.length)return void(elements.restoreList.innerHTML='<div style="color: var(--text-sub); padding: 12px;">ì‚­ì œëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>');const n=t.slice(0,200).map(e=>{const t=formatKst(e.deletedAt)||"",n=formatPostTypeLabel(e.type),a=e.author?.name?`${e.author.name}${e.author?.class?` (${e.author.class})`:""}`:"(ì‘ì„±ì ì—†ìŒ)",s=`${e.deletedReasonCode||""}${e.deletedReason?` / ${e.deletedReason}`:""}`;return`\n            <div class="audit-item">\n                <div class="audit-top">\n                    <div class="audit-type">${escapeHtml(n)} <span style="color: var(--text-muted); font-weight:700;">(ë³µêµ¬ ê°€ëŠ¥)</span></div>\n                    <div class="audit-time">${escapeHtml(t)} <span style="color: var(--text-muted);">(${escapeHtml(e.deletedAt)})</span></div>\n                </div>\n                <div class="audit-body">\nì œëª©: ${escapeHtml(e.title||"")}\nì‘ì„±ì: ${escapeHtml(a)}\npostId: ${escapeHtml(e.id||"")}\nì‚¬ìœ : ${escapeHtml(s)}\n                </div>\n                <div class="admin-tools-row" style="margin-top:10px;">\n                    <button class="btn-success" onclick="restoreSoftDeletedPost('${escapeHtml(e.id)}')"><i class="fa-solid fa-rotate-left"></i> ë³µêµ¬</button>\n                </div>\n            </div>\n        `}).join("");elements.restoreList.innerHTML=n}function renderAuditLogs(){if(!elements.auditList)return;const e=elements.auditTypeFilter?.value||"all",t=(elements.auditSearch?.value||"").trim().toLowerCase();let n=auditCache.slice();if("all"!==e&&(n=n.filter(t=>t.eventType===e)),t&&(n=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t))),!n.length)return void(elements.auditList.innerHTML='<div style="color: var(--text-sub); padding: 12px;">í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');const a=n.slice(0,200).map(e=>{const t=formatKst(e.createdAt)||"",n=e.createdAt||"",a=e.actor?.by||"(unknown)",s=e.actor?.isAdmin?" (admin)":"",r=e.actor?.discordUserId?` / discord:${e.actor.discordUserId}`:"",o=e.payload?.previousData?.title||e.payload?.title||"",i=e.payload?.postId||e.payload?.id||"",l=e.payload?.message||e.payload?.error||"",c=[i?`postId=${i}`:null,o?`title="${o}"`:null,l?`msg="${l}"`:null].filter(Boolean).join(" / ");return`\n            <div class="audit-item">\n                <div class="audit-top">\n                    <div class="audit-type">${escapeHtml(e.eventType||"")}</div>\n                    <div class="audit-time">${escapeHtml(t)} <span style="color: var(--text-muted);">(${escapeHtml(n)})</span></div>\n                </div>\n                <div class="audit-body">\nê°ì§€ì: ${escapeHtml(a)}${escapeHtml(s)}${escapeHtml(r)}\n${escapeHtml(c)}\n                </div>\n            </div>\n        `}).join("");elements.auditList.innerHTML=a}function loadAuditLogs(){db&&elements.auditList&&(elements.auditList.innerHTML='<div style="color: var(--text-sub); padding: 12px;">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>',auditUnsub&&(auditUnsub(),auditUnsub=null),auditUnsub=db.collection("audit_logs").orderBy("createdAt","desc").limit(200).onSnapshot(e=>{auditCache=[],e.forEach(e=>auditCache.push({id:e.id,...e.data()})),renderAuditLogs()},e=>{console.error(e),elements.auditList.innerHTML=`<div style="color: var(--danger); padding: 12px;">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(e?.message||String(e))}</div>`}))}function downloadJson(e,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json;charset=utf-8"}),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=e,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(a)}function exportPostsJson(e){if(!currentUser?.isAdmin)return void alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");const t=!!e?.includeDeleted,n=!!e?.onlyNotices;let a=posts.slice();t||(a=a.filter(e=>!e.deletedAt)),n&&(a=a.filter(e=>"notice"===e.type));const s=a.map(e=>({...e}));downloadJson(`${n?"notices":t?"posts_all_including_deleted":"posts"}_${(new Date).toISOString().replace(/[:.]/g,"-")}.json`,s),showToast(`<i class="fa-solid fa-file-export"></i> ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: ${s.length}ê°œ`)}async function importPostsJson(){if(!currentUser?.isAdmin)return void alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");const e=elements.importJsonText?.value||"";if(!e.trim())return alert("JSONì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.");let t;try{t=JSON.parse(e)}catch(e){return void alert("JSON íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.")}if(!Array.isArray(t))return void alert('JSONì€ ë°°ì—´ í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ: [{"id":"..."}]');const n=elements.importMode?.value||"upsert";if(!confirm(`ê°€ì ¸ì˜¤ê¸° ${t.length}ê±´ì„ ì§„í–‰í• ê¹Œìš”?\nëª¨ë“œ: ${n}`))return;const a=[];for(let e=0;e<t.length;e+=400)a.push(t.slice(e,e+400));let s=0,r=0;for(const e of a){const t=db.batch();for(const a of e){if(!a||"object"!=typeof a)continue;const e=a.id,o=e?db.collection("posts").doc(String(e)):db.collection("posts").doc(),i={...a};delete i.id,i.createdAt||(i.createdAt=(new Date).toISOString()),i.type||(i.type="party"),"create_only"!==n?(t.set(o,i,{merge:!0}),s++):r++}await t.commit()}showToast(`<i class="fa-solid fa-file-import"></i> ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: upsert ${s} / skip ${r}`)}function readCalcStatsFromInputs(){const e=e=>parseFloat(e?.value)||0;return{attackPower:Math.max(0,e(elements.calcAttackPower)),weaponMin:Math.max(0,e(elements.calcWeaponMin)),weaponMax:Math.max(0,e(elements.calcWeaponMax)),critStat:Math.max(0,e(elements.calcCritStat)),combatSpeed:clampPercent(e(elements.calcCombatSpeed)),weaponDamageAmp:clampPercent(e(elements.calcWeaponDamageAmp)),damageAmp:clampPercent(e(elements.calcDamageAmp),999),critDamageAmp:clampPercent(e(elements.calcCritDamageAmp),999),skillDamage:clampPercent(e(elements.calcSkillDamage),999),cooldownReduction:clampPercent(e(elements.calcCooldownReduction),95),stunHit:clampPercent(e(elements.calcStunHit),999),perfect:clampPercent(e(elements.calcPerfect),999),multiHit:clampPercent(e(elements.calcMultiHit),999)}}function computeAtulScoreFromStats(e,t={}){const n=t.critMode||"legacy",a=e.attackPower||0,s=e.weaponMin||0,r=e.weaponMax||0,o=e.critStat||0,i=e.combatSpeed||0,l=e.weaponDamageAmp||0,c=e.damageAmp||0,d=e.critDamageAmp||0,m=e.skillDamage||0,u=e.cooldownReduction||0,p=e.stunHit||0,g=e.perfect||0,h=e.multiHit||0,f={};i>0&&(f.combatSpeed=i),l>0&&(f.weaponDamageAmp=.66*l),c>0&&(f.damageAmp=c);const y=clampPercent(convertCritStatToChance(o));let v=a;const E=Math.min(Math.max(y/100,0),1);if("legacy"===n){if(d>0&&y>0){const e=100*((1*(1-E)+E*(1.5+d/100))/(1*(1-E)+1.5*E)-1);f.criticalDamageAmp=e}}else{const e=1*(1-E)+E*(1.5+d/100);e>1&&(f.criticalExpected=100*(e-1))}if(m>0&&(f.skillDamage=m),u>0&&u<100){const e=100*(100/(100-u)-1)*.5;f.cooldownReduction=e}if(p>0&&(f.stunHit=p),g>0&&s>0&&r>0&&r>s){const e=g*((r-s)/(r+s));f.perfect=e}if(h>0){const e=18,t=e+h,n=e=>11.1*e+13.9*Math.pow(e,2)+17.8*Math.pow(e,3)+23.9*Math.pow(e,4),a=n(e/100),s=100*((1+n(t/100)/100)/(1+a/100)-1);f.multiHit=s}let b=1;for(const e in f)b*=1+f[e]/100;const T=v*b;return{score:Math.round(T),totalMultiplier:b,criticalChance:y}}function calculateEstimatedDps(){const e=readCalcStatsFromInputs(),{score:t}=computeAtulScoreFromStats(e,{critMode:"legacy"});if(elements.calcResultScore.textContent=t.toLocaleString(),elements.calcDiff){if(null===lastSimulatedScore||!Number.isFinite(lastSimulatedScore))return lastSimulatedScore=t,elements.calcDiff.textContent="(0)",void(elements.calcDiff.style.color="var(--text-muted)");const e=t-lastSimulatedScore;lastSimulatedScore=t;const n=e>0?"+":"";elements.calcDiff.textContent=`(${n}${e.toLocaleString()})`,elements.calcDiff.style.color=e>0?"var(--success)":e<0?"var(--danger)":"var(--text-muted)"}}function recommendStatsForTargetScore(){const e=elements.calcRecommendOutput;if(!e)return;const t=parseFloat(elements.calcTargetScore?.value)||0,n=readCalcStatsFromInputs(),a=computeAtulScoreFromStats(n,{critMode:"legacy"});if(!t||t<=0)return void(e.textContent="ëª©í‘œ ì „íˆ¬ë ¥ì„ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");if(t<=a.score)return void(e.textContent=`ì´ë¯¸ ëª©í‘œ ë‹¬ì„± ìƒíƒœì…ë‹ˆë‹¤.\ní˜„ì¬ ${a.score.toLocaleString()} â‰¥ ëª©í‘œ ${Math.round(t).toLocaleString()}`);const s=[{key:"attackPower",label:"ê³µê²©ë ¥",step:100,apply:(e,t)=>({...e,attackPower:e.attackPower+t})},{key:"weaponDamage",label:"ë¬´ê¸°ê³µê²©ë ¥(ìµœì†Œ+ìµœëŒ€)",step:5,apply:(e,t)=>({...e,weaponMin:e.weaponMin+t,weaponMax:e.weaponMax+t})},{key:"critStat",label:"ì¹˜ëª…íƒ€ ìˆ˜ì¹˜",step:200,apply:(e,t)=>({...e,critStat:e.critStat+t})},{key:"combatSpeed",label:"ì „íˆ¬ ì†ë„(%)",step:1,apply:(e,t)=>({...e,combatSpeed:clampPercent(e.combatSpeed+t)})},{key:"weaponDamageAmp",label:"ë¬´ê¸° í”¼í•´ ì¦í­(%)",step:1,apply:(e,t)=>({...e,weaponDamageAmp:clampPercent(e.weaponDamageAmp+t)})},{key:"damageAmp",label:"í”¼í•´ ì¦í­(í†µí•© %)",step:1,apply:(e,t)=>({...e,damageAmp:Math.max(0,e.damageAmp+t)})},{key:"critDamageAmp",label:"ì¹˜ëª…íƒ€ í”¼í•´ ì¦í­(%)",step:1,apply:(e,t)=>({...e,critDamageAmp:Math.max(0,e.critDamageAmp+t)})},{key:"skillDamage",label:"ìŠ¤í‚¬ í”¼í•´ ì¦í­(%)",step:1,apply:(e,t)=>({...e,skillDamage:Math.max(0,e.skillDamage+t)})},{key:"cooldownReduction",label:"ì¬ì‚¬ìš© ëŒ€ê¸°ì‹œê°„ ê°ì†Œ(%)",step:1,apply:(e,t)=>({...e,cooldownReduction:clampPercent(e.cooldownReduction+t,95)})},{key:"stunHit",label:"ê°•íƒ€ ì ì¤‘(%)",step:1,apply:(e,t)=>({...e,stunHit:Math.max(0,e.stunHit+t)})},{key:"perfect",label:"ì™„ë²½(%)",step:1,apply:(e,t)=>({...e,perfect:Math.max(0,e.perfect+t)})},{key:"multiHit",label:"ë‹¤ë‹¨ íˆíŠ¸ ì ì¤‘(%)",step:1,apply:(e,t)=>({...e,multiHit:Math.max(0,e.multiHit+t)})}],r=(e,t)=>{const n=computeAtulScoreFromStats(e,{critMode:"legacy"}).score,a=t.apply(e,t.step);return{gain:computeAtulScoreFromStats(a,{critMode:"legacy"}).score-n,nextStats:a}},o=(e,t)=>{const n=computeAtulScoreFromStats(e,{critMode:"expected"}).score,a=t.apply(e,t.step);return{gain:computeAtulScoreFromStats(a,{critMode:"expected"}).score-n,nextStats:a}},i=s.map(e=>{const t=o(n,e),a=r(n,e);return{key:e.key,label:e.label,step:e.step,expectedGain:t.gain,legacyGain:a.gain}}).sort((e,t)=>t.expectedGain-e.expectedGain),l=i.slice();let c={...n},d=a.score;const m=new Map;for(let e=0;e<2e3&&d<t;e++){let e=null;for(const t of s){const n=o(c,t),a=r(c,t),s=n.gain;(!e||s>e.choiceGain)&&(e={k:t,choiceGain:s,legacyGain:a.gain,nextStats:a.nextStats})}if(!e||e.legacyGain<=0)break;c=e.nextStats,d=computeAtulScoreFromStats(c,{critMode:"legacy"}).score,m.set(e.k.label,(m.get(e.k.label)||0)+e.k.step)}const u=Math.max(0,Math.round(t)-d),p=l.slice(0,5).map((e,t)=>{const n=e.expectedGain||0,a=e.legacyGain||0,s=Number.isInteger(e.step)?e.step:e.step.toFixed(1);return`${t+1}. ${e.label} +${s} â†’ ì¶”ì²œíŒë‹¨ +${n.toLocaleString()} / í‘œì‹œê¸°ì¤€ +${a.toLocaleString()}`}).join("\n"),g=Array.from(m.entries()).map(([e,t])=>`- ${e}: +${Number.isInteger(t)?t:t.toFixed(1)}`),h=i.map(e=>{const t=e.expectedGain||0,n=e.legacyGain||0,a=Number.isInteger(e.step)?e.step:e.step.toFixed(1);return`- ${e.label} +${a} â†’ ì¶”ì²œíŒë‹¨ +${t.toLocaleString()} / í‘œì‹œê¸°ì¤€ +${n.toLocaleString()}`}).join("\n"),f=[];n.weaponMin&&n.weaponMax||f.push('ë¬´ê¸° ìµœì†Œ/ìµœëŒ€ê°€ 0ì´ë©´ "ì™„ë²½" ê³„ì‚°ì´ ì‚¬ì‹¤ìƒ ì˜ë¯¸ê°€ ì—†ê±°ë‚˜(ì¡°ê±´ ë¯¸ì¶©ì¡±), ê²°ê³¼ê°€ ì™œê³¡ë  ìˆ˜ ìˆì–´ìš”.'),n.weaponMax<=n.weaponMin&&f.push('ë¬´ê¸° ìµœëŒ€ê³µê²©ë ¥ì´ ìµœì†Œê³µê²©ë ¥ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ìœ¼ë©´ "ì™„ë²½" ê¸°ëŒ€ ì¦ê°€ëŸ‰ì´ 0ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.'),n.cooldownReduction>=95&&f.push("ì¬ì‚¬ìš© ëŒ€ê¸°ì‹œê°„ ê°ì†ŒëŠ” ìˆ˜ì‹ìƒ 100%ì— ê°€ê¹Œì›Œì§ˆìˆ˜ë¡ ë¶„ëª¨ê°€ ì‘ì•„ì ¸ ê¸‰ê²©íˆ ì»¤ì§ˆ ìˆ˜ ìˆì–´ 95% ìƒí•œìœ¼ë¡œ ì œí•œí–ˆìŠµë‹ˆë‹¤.");const y=Math.max(0,Math.round(t)-a.score),v=g.length?g.join("\n"):"- (ì¶”ì²œ ê°€ëŠ¥í•œ ì¦ê°€ê°€ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ê°’/ìƒí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”)",E=f.length?`\n\n[ì£¼ì˜/ê°€ì •]\n- ${f.join("\n- ")}`:"";e.innerHTML=`<div style="font-weight:700; color: var(--text-main);">ëª©í‘œ ë‹¬ì„± ì¶”ì²œ ê²°ê³¼</div><div style="margin-top:6px; color: var(--text-sub);">í˜„ì¬ <b>${a.score.toLocaleString()}</b> â†’ ëª©í‘œ <b>${Math.round(t).toLocaleString()}</b> (í•„ìš” +${y.toLocaleString()})</div><div style="margin-top:10px; padding:10px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,0.03);"><div style="font-size:0.85rem; color: var(--text-sub); line-height:1.6;">- <b>í‘œì‹œê¸°ì¤€</b>: í™”ë©´ì˜ â€œì˜ˆìƒ ì•„íˆ´ ì „íˆ¬ë ¥(ê³„ì‚°í•˜ê¸°)â€ê³¼ ê°™ì€ ê¸°ì¤€(ê¸°ì¡´ ê³„ì‚°)<br>- <b>ì¶”ì²œíŒë‹¨</b>: ì–´ë–¤ ìŠ¤íƒ¯ì´ íš¨ìœ¨ì ì¸ì§€ ê³ ë¥¼ ë•ŒëŠ” ì¹˜ëª… ê¸°ëŒ€ê°’ê¹Œì§€ ë°˜ì˜í•´ì„œ íŒë‹¨</div></div><div style="margin-top:14px;"><b>TOP 5 (ì™œ ì´ ìˆœì„œì¸ì§€)</b></div><pre style="margin-top:6px; white-space:pre-wrap; font-family:inherit; color: var(--text-sub);">${escapeHtml(p)}</pre><details style="margin-top:10px;"><summary style="cursor:pointer; color: var(--primary-light); font-weight:700;">ì „ì²´ ë³€í™”ëŸ‰(ìì„¸íˆ ë³´ê¸°)</summary><pre style="margin-top:8px; white-space:pre-wrap; font-family:inherit; color: var(--text-sub);">${escapeHtml(h)}</pre></details><div style="margin-top:14px;"><b>ì¶”ì²œ í”Œëœ</b></div><pre style="margin-top:6px; white-space:pre-wrap; font-family:inherit; color: var(--text-sub);">${escapeHtml(v)}</pre><div style="margin-top:10px; color: var(--text-sub);">ì˜ˆìƒ ë„ë‹¬ ì „íˆ¬ë ¥(í‘œì‹œê¸°ì¤€): <b>${d.toLocaleString()}</b>`+(u>0?` <span style="color: var(--warning); font-weight:700;">(ëª©í‘œê¹Œì§€ ì•½ ${u.toLocaleString()} ë¶€ì¡±)</span>`:' <span style="color: var(--success); font-weight:700;">(ëª©í‘œ ë‹¬ì„±)</span>')+"</div>"+(f.length?`<pre style="margin-top:10px; white-space:pre-wrap; font-family:inherit; color: var(--text-muted);">${escapeHtml(E.trim())}</pre>`:"")}function openWriteModal(e,t=null){if(e&&!currentUser)return alert("ê³µì§€ì‚¬í•­ ì‘ì„±ì€ ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."),void elements.authModal.classList.remove("hidden");if(e&&!currentUser.isAdmin)return void alert("ê³µì§€ì‚¬í•­ ì‘ì„±ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");isNoticeWritingMode=e,isEditMode=!!t,editingPostData=t,elements.writeModal.classList.remove("hidden"),elements.postForm.reset(),elements.detailSelectGroup&&elements.detailSelectGroup.classList.add("hidden"),elements.postDetail&&(elements.postDetail.innerHTML='<option value="">ì„ íƒ</option>'),elements.postDifficulty&&(elements.postDifficulty.innerHTML='<option value="">ë‚œì´ë„</option>'),currentUser?.dps&&elements.postMyDps&&(elements.postMyDps.value=currentUser.dps),isEditMode&&t?(elements.postTitle.value=t.title,elements.postContent.value=t.content,elements.submitPostBtn.textContent="ìˆ˜ì •í•˜ê¸°",elements.modalTitle.textContent=e?"ê³µì§€ì‚¬í•­ ìˆ˜ì •":"ê²Œì‹œê¸€ ìˆ˜ì •"):(elements.submitPostBtn.textContent="ë“±ë¡í•˜ê¸°",elements.modalTitle.textContent=e?"ê³µì§€ì‚¬í•­ ì‘ì„±":"íŒŒí‹° ëª¨ì§‘ê¸€ ì‘ì„±");const n=!currentUser;e?(elements.noticeMessage&&elements.noticeMessage.classList.remove("hidden"),elements.categoryGroup&&elements.categoryGroup.classList.add("hidden"),elements.roleGroup&&elements.roleGroup.classList.add("hidden"),elements.linkGroup&&elements.linkGroup.classList.add("hidden"),elements.dpsGroup&&elements.dpsGroup.classList.add("hidden"),elements.expirationGroup&&elements.expirationGroup.classList.add("hidden"),elements.guestNameGroup&&elements.guestNameGroup.classList.add("hidden"),elements.guestPasswordGroup&&elements.guestPasswordGroup.classList.add("hidden"),elements.postCategory&&elements.postCategory.removeAttribute("required")):(elements.noticeMessage&&elements.noticeMessage.classList.add("hidden"),elements.categoryGroup&&elements.categoryGroup.classList.add("hidden"),elements.roleGroup&&elements.roleGroup.classList.add("hidden"),elements.linkGroup&&elements.linkGroup.classList.add("hidden"),elements.dpsGroup&&elements.dpsGroup.classList.add("hidden"),elements.expirationGroup&&elements.expirationGroup.classList.remove("hidden"),elements.postCategory&&elements.postCategory.removeAttribute("required"),elements.guestNameGroup&&elements.guestNameGroup.classList.toggle("hidden",!n),elements.guestPasswordGroup&&elements.guestPasswordGroup.classList.toggle("hidden",!n),elements.postGuestName&&(elements.postGuestName.value=""),elements.postGuestPassword&&(elements.postGuestPassword.value=""))}window.restoreSoftDeletedPost=async function(e){if(!currentUser?.isAdmin)return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");if(!db)return alert("DB ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");if(!e)return;const t=posts.find(t=>t.id===e);if(!t)return alert("ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");if(!t.deletedAt)return alert("ì´ë¯¸ ì‚­ì œ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.");if(!confirm(`ì´ ê¸€ì„ ë³µêµ¬í• ê¹Œìš”?\n\n- ì œëª©: ${t.title||""}\n- ì‘ì„±ì: ${t.author?.name||""}\n- ì‚­ì œì‚¬ìœ : ${t.deletedReasonCode||""}`))return;const n=firebase.firestore.FieldValue.delete(),a={deletedAt:n,deletedReasonCode:n,deletedReason:n,deletedActor:n,deletedSource:n,status:"recruiting"};try{await db.collection("posts").doc(e).update(a),showToast('<i class="fa-solid fa-rotate-left"></i> ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.'),sendLogToDiscord(["ğŸŸ¢ **ë³µêµ¬ ì‹¤í–‰**",`- postId: ${e}`,`- type: ${t.type}`,`- title: ${t.title||""}`,`- by: ${currentUser?.name||"unknown"} (admin)`,`- at(KST): ${formatKst((new Date).toISOString())||""}`])}catch(e){console.error(e),alert("ë³µêµ¬ ì‹¤íŒ¨: "+(e?.message||String(e)))}};let authMode="login",signupUidInFlight=null;async function waitForUserProfile(e,t=12,n=200){if(!db||!e)return null;const a=db.collection(FIRESTORE_POINTS.userProfiles).doc(e);for(let e=0;e<t;e++){const e=await a.get().catch(()=>null);if(e?.exists)return e;await new Promise(e=>setTimeout(e,n))}return null}function setAuthMode(e){authMode="signup"===e?"signup":"login",elements.authTabLogin&&elements.authTabLogin.classList.toggle("active","login"===authMode),elements.authTabSignup&&elements.authTabSignup.classList.toggle("active","signup"===authMode);const t="signup"===authMode;elements.authModalTitle&&(elements.authModalTitle.textContent=t?"íšŒì›ê°€ì…":"ë¡œê·¸ì¸"),elements.authSubmitBtn&&(elements.authSubmitBtn.textContent=t?"íšŒì›ê°€ì…":"ë¡œê·¸ì¸"),elements.authNicknameGroup&&elements.authNicknameGroup.classList.toggle("hidden",!t),elements.authPasswordConfirmGroup&&elements.authPasswordConfirmGroup.classList.toggle("hidden",!t),elements.authHelpText&&(elements.authHelpText.innerHTML=t?"íšŒì›ê°€ì… í›„ ë‹‰ë„¤ì„ì€ <b>ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</b>.<br>í¬ì¸íŠ¸ ê¸°ëŠ¥ì€ <b>ê´€ë¦¬ì ìŠ¹ì¸</b> í›„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.":"ê´€ë¦¬ì ì „ìš© ë¡œê·¸ì¸ì…ë‹ˆë‹¤.<br>ì¼ë°˜ ìœ ì €ëŠ” ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ë„ ê²Œì‹œê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."),elements.authPassword&&elements.authPassword.setAttribute("autocomplete",t?"new-password":"current-password"),elements.authPasswordConfirm&&(elements.authPasswordConfirm.value="")}async function initAuth(){auth&&db&&(setAuthMode("login"),auth.onAuthStateChanged(async e=>{if(!e)return currentUser=null,void updateUserUI();try{const t=db.collection(FIRESTORE_POINTS.userProfiles).doc(e.uid),n=db.collection(FIRESTORE_POINTS.admins).doc(e.uid),a=db.collection(FIRESTORE_POINTS.roots).doc(e.uid);let[s,r,o]=await Promise.all([t.get(),n.get(),a.get()]);if(!s.exists&&signupUidInFlight&&signupUidInFlight===e.uid){const t=await waitForUserProfile(e.uid,15,200);t?.exists&&(s=t,r=await n.get(),o=await a.get())}if(!s.exists)return await auth.signOut(),currentUser=null,updateUserUI(),void alert("íšŒì› í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ íšŒì›ê°€ì…í•´ ì£¼ì„¸ìš”.\n\n- ë³´í†µ íšŒì›ê°€ì… ì¤‘ Firestore ê¶Œí•œ(Rules) ë¬¸ì œë¡œ í”„ë¡œí•„ ìƒì„±ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤.\n- Firebase ì½˜ì†”ì˜ Authenticationì— ì‚¬ìš©ìë§Œ ìƒì„±ë˜ê³ , Firestoreì— user_profilesê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");const i=s.data()||{},l=normalizeNickname(i.nickname),c=!!i.pointsApproved,d=r.exists,m=o.exists;currentUser={uid:e.uid,name:l||"(ë‹‰ë„¤ì„ ì—†ìŒ)",class:"íšŒì›",level:0,itemLevel:0,dps:0,avatar:null,verified:!0,isAdmin:d||m,isRoot:m,pointsApproved:c},updateUserUI();try{!autoAttendanceRanThisSession&&(currentUser.pointsApproved||currentUser.isAdmin||currentUser.isRoot)&&(autoAttendanceRanThisSession=!0,await ensurePointDocsForCurrentUser(),await doAttendanceCheck({silent:!0}))}catch(e){console.warn("auto attendance failed:",e)}try{!autoCharacterRefreshRanThisSession&&currentUser?.name&&(autoCharacterRefreshRanThisSession=!0,await refreshCurrentUserCharacter(),updateUserUI())}catch(e){console.warn("auto character refresh failed:",e)}}catch(e){console.error(e),alert("ë¡œê·¸ì¸ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n"+formatFirestoreError(e))}}))}function isValidLoginId(e){return/^[a-zA-Z0-9._-]{3,20}$/.test(String(e||""))}function loginIdToEmail(e){return`${String(e||"").trim().toLowerCase()}@aion2rudra.local`}async function applyAuthPersistence(){if(!auth)return;const e=!!elements.authRememberMe?.checked?firebase.auth.Auth.Persistence.LOCAL:firebase.auth.Auth.Persistence.SESSION;try{await auth.setPersistence(e)}catch(e){console.error("setPersistence failed:",e)}}async function submitAuthForm(){if(!auth||!db)return alert("Auth/DB ì´ˆê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.");const e=String(elements.authLoginId?.value||"").trim(),t=String(elements.authPassword?.value||""),n=String(elements.authNickname?.value||"").trim();if(!e)return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");if(!isValidLoginId(e))return alert("ì•„ì´ë”” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\n- 3~20ì\n- ì˜ë¬¸/ìˆ«ì/._- ë§Œ í—ˆìš©");if(!t||t.length<6)return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ 6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");const a=loginIdToEmail(e);if("login"===authMode){try{await applyAuthPersistence(),await auth.signInWithEmailAndPassword(a,t),elements.authModal.classList.add("hidden")}catch(e){console.error(e),alert("ë¡œê·¸ì¸ ì‹¤íŒ¨:\n\n"+formatFirestoreError(e))}return}if(!n)return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");if(n.length<2)return alert("ë‹‰ë„¤ì„ì€ 2ê¸€ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.");if(n.length>20)return alert("ë‹‰ë„¤ì„ì€ 20ê¸€ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”.");const s=nicknameKey(n);if(!s)return alert("ë‹‰ë„¤ì„ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");const r=String(elements.authPasswordConfirm?.value||"");if(!r)return alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•˜ì„¸ìš”.");if(t!==r)return alert("ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");let o=null;try{await applyAuthPersistence(),o=await auth.createUserWithEmailAndPassword(a,t);const r=o.user.uid;signupUidInFlight=r;try{await o.user.getIdToken(!0)}catch{}const i=db.collection(FIRESTORE_POINTS.nicknameIndex).doc(s),l=db.collection(FIRESTORE_POINTS.userProfiles).doc(r);await db.runTransaction(async t=>{const[a,o]=await Promise.all([t.get(i),t.get(l)]);if(a.exists)throw new Error("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");if(o.exists)throw new Error("í”„ë¡œí•„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.");t.set(i,{uid:r,nickname:n,nicknameLower:s,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),t.set(l,{uid:r,nickname:n,nicknameLower:s,loginId:String(e),loginIdLower:String(e).trim().toLowerCase(),pointsApproved:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp(),approvedAt:null,approvedBy:null})}),elements.authModal.classList.add("hidden"),showToast('<i class="fa-solid fa-user-plus"></i> íšŒì›ê°€ì… ì™„ë£Œ! í¬ì¸íŠ¸ëŠ” ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'),signupUidInFlight=null}catch(e){console.error(e);try{o?.user&&await o.user.delete()}catch{}signupUidInFlight=null;const t=String(e?.code||""),n=String(e?.message||formatFirestoreError(e)||"");if("auth/email-already-in-use"===t)return void alert("íšŒì›ê°€ì… ì‹¤íŒ¨:\n\nì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.\n\n- ê°™ì€ ì•„ì´ë””ë¡œ ì´ë¯¸ ê°€ì…ë˜ì–´ ìˆìœ¼ë©´ â€œë¡œê·¸ì¸â€ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.\n- ì •ë§ ìƒˆë¡œ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´ ë‹¤ë¥¸ ì•„ì´ë””ë¡œ ê°€ì…í•´ì•¼ í•©ë‹ˆë‹¤.");alert("íšŒì›ê°€ì… ì‹¤íŒ¨:\n\n"+n+"\n\n(ì°¸ê³ : Firestore Rulesì—ì„œ user_profiles/nickname_index ìƒì„±ì´ ë§‰íˆë©´ ì´ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)")}}async function logout(){try{auth&&await auth.signOut()}catch(e){console.error(e)}}function updateUserUI(){currentUser?(elements.loginBtn.classList.add("hidden"),elements.userInfo.classList.remove("hidden"),elements.userNickname.textContent=currentUser.name,elements.adminBadge&&elements.adminBadge.classList.toggle("hidden",!currentUser.isAdmin),elements.rootBadge&&elements.rootBadge.classList.toggle("hidden",!currentUser.isRoot),elements.adminVerifyBtn&&elements.adminVerifyBtn.classList.add("hidden"),elements.adminToolsBtn&&elements.adminToolsBtn.classList.toggle("hidden",!currentUser.isAdmin),elements.pointsAdminTabBtn&&elements.pointsAdminTabBtn.classList.toggle("hidden",!currentUser.isAdmin),elements.pointsEventTabBtn&&elements.pointsEventTabBtn.classList.toggle("hidden",!currentUser.isRoot),elements.rootEventCard&&elements.rootEventCard.classList.toggle("hidden",!currentUser.isRoot),elements.rootGachaControlCard&&elements.rootGachaControlCard.classList.toggle("hidden",!currentUser.isRoot),elements.rootBulkPointsCard&&elements.rootBulkPointsCard.classList.toggle("hidden",!currentUser.isRoot),currentUser.isAdmin?elements.writeNoticeBtn.classList.remove("hidden"):elements.writeNoticeBtn.classList.add("hidden"),currentUser.pointsApproved||currentUser.isAdmin?ensurePointDocsForCurrentUser().then(()=>{refreshPointsHeader().catch(()=>{})}):elements.pointsBalanceText&&(elements.pointsBalanceText.textContent="í¬ì¸íŠ¸(pt)")):(elements.loginBtn.classList.remove("hidden"),elements.userInfo.classList.add("hidden"),elements.writeNoticeBtn.classList.add("hidden"),elements.adminVerifyBtn&&elements.adminVerifyBtn.classList.add("hidden"),elements.adminBadge&&elements.adminBadge.classList.add("hidden"),elements.rootBadge&&elements.rootBadge.classList.add("hidden"),elements.adminToolsBtn&&elements.adminToolsBtn.classList.add("hidden"),elements.pointsAdminTabBtn&&elements.pointsAdminTabBtn.classList.add("hidden"),elements.pointsEventTabBtn&&elements.pointsEventTabBtn.classList.add("hidden"),elements.rootEventCard&&elements.rootEventCard.classList.add("hidden"),elements.rootGachaControlCard&&elements.rootGachaControlCard.classList.add("hidden"),elements.rootBulkPointsCard&&elements.rootBulkPointsCard.classList.add("hidden"),elements.pointsBalanceText&&(elements.pointsBalanceText.textContent="0pt"))}async function handlePostSubmit(e){if(e.preventDefault(),!db)return void alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.");if(isSubmittingPost)return;isSubmittingPost=!0;const t=elements.submitPostBtn,n=t?t.textContent:"";t&&(t.disabled=!0,t.textContent="ë“±ë¡ ì¤‘...");const a=!currentUser,s=elements.postGuestName?.value?.trim()||"",r=elements.postGuestPassword?.value||"";let o=currentTab;"completed"===currentTab&&(o="party");let i=0;if(isNoticeWritingMode)o="notice";else{const e=parseInt(elements.postExpiration?.value||"3",10);if(i=e>0?60*e*60*1e3:0,a){if(!s)return void alert("ê²Œì„ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");if(!r||r.length<4)return void alert("ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ 4ìë¦¬ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.")}}let l=null;if(!isNoticeWritingMode&&a&&(l=await fetchCharacterData(s).catch(()=>null)),!isNoticeWritingMode&&!a&&currentUser?.name){if(!(currentUser.class&&currentUser.itemLevel&&currentUser.avatar&&currentUser.charKey)){const e=await fetchCharacterData(currentUser.name).catch(()=>null);e&&(currentUser.class=e.class||currentUser.class,currentUser.itemLevel=e.item_level||currentUser.itemLevel,currentUser.avatar=e.profile_img||currentUser.avatar,currentUser.charKey=e.charKey||currentUser.charKey)}}const c={title:elements.postTitle.value,content:elements.postContent.value};if(isEditMode)editingPostData&&"notice"===editingPostData.type&&(c.expirationTime=0);else if(c.type=o,c.createdAt=(new Date).toISOString(),c.expirationTime=isNoticeWritingMode?0:i,c.status="recruiting",a){const e=l||{};c.authorUid=null,c.password=r,c.members=[{name:e.name||s,class:e.class||null,dps:0,itemLevel:e.item_level||e.itemLevel||null,charKey:e.charKey||null,avatar:e.profile_img||null,isLeader:!0}],c.author={name:e.name||s,class:e.class||null,level:e.level||null,itemLevel:e.item_level||e.itemLevel||null,dps:0,charKey:e.charKey||null,avatar:e.profile_img||null,verified:!1,uid:null}}else c.authorUid=currentUser.uid||null,c.members=[{name:currentUser.name,class:currentUser.class,dps:currentUser.dps||0,itemLevel:currentUser.itemLevel,charKey:currentUser.charKey||null,avatar:currentUser.avatar,isLeader:!0}],c.author={name:currentUser.name,class:currentUser.class,level:currentUser.level,itemLevel:currentUser.itemLevel,dps:currentUser.dps||0,charKey:currentUser.charKey||null,avatar:currentUser.avatar,verified:!!currentUser.verified,uid:currentUser.uid||null};try{if(isEditMode&&editingPostData)await db.collection("posts").doc(editingPostData.id).update(c),elements.writeModal.classList.add("hidden"),elements.postForm.reset(),showToast('<i class="fa-solid fa-check"></i> ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');else{const t=await sendDiscordNotification(c);t&&(c.discordMessageId=t);const n=await db.collection("posts").add(c);if(elements.writeModal.classList.add("hidden"),elements.postForm.reset(),showToast('<i class="fa-solid fa-check"></i> ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.'),currentUser?.uid)try{await ensurePointDocsForCurrentUser(),await awardPostCreatePoints(c.type,n?.id)}catch(e){console.error(e)}}}catch(e){console.error(e),alert(isEditMode?"ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.":"ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{isSubmittingPost=!1,t&&(t.disabled=!1,t.textContent=n||"ë“±ë¡í•˜ê¸°")}}function buildDiscordPayload(e){let t="ğŸ“¢",n="íŒŒí‹°ì› ëª¨ì§‘";"member"===e.type?(t="âš”ï¸",n="íŒŒí‹° êµ¬ì§"):"notice"===e.type&&(t="ğŸ””",n="ê³µì§€ì‚¬í•­");let a=e.category||"";e.categoryDetail&&(a+=` - ${e.categoryDetail}`),e.difficulty&&(a+=` (${e.difficulty})`);let s=`${e?.author?.name||"ì‘ì„±ì"}${e?.author?.class?` (${e.author.class})`:""}`;"member"===e.type&&e.author?.dps>0&&(s+=` / DPS ${e.author.dps.toLocaleString()}`);let r=`\n**${e.title}**\n\n`;return r+=`${e.content}\n\n`,r+=`ğŸ‘¤ **ì‘ì„±ì:** ${s}\n`,"notice"!==e.type&&(a&&(r+=`ğŸ® **ì½˜í…ì¸ :** ${a}\n`),Array.isArray(e.roles)&&e.roles.length&&(r+=`ğŸ¯ **ëŒ€ìƒ:** ${e.roles.join(", ")}`)),e.link&&(r+=`\n\nğŸ”— [ì˜¤í”ˆì±„íŒ…/ë””ì½” ë°”ë¡œê°€ê¸°](${e.link})`),{content:null,embeds:[{title:`${t} ${n}`,url:window.location.href,description:r,color:"party"===e.type?7506394:"member"===e.type?5763719:15105570,footer:{text:"ì „íˆ¬&ëª…ê°€ íŒŒí‹° ë§¤ì¹­"},timestamp:(new Date).toISOString()}]}}function sendDiscordNotification(e){if(DISCORD_POST_WEBHOOK_URL.includes("ì—¬ê¸°ì—"))return Promise.resolve(null);const t=buildDiscordPayload(e);return fetch(`${DISCORD_POST_WEBHOOK_URL}?wait=true`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>e.id).catch(e=>(console.error("Discord Webhook Error:",e),null))}function deleteDiscordMessage(e){e.discordMessageId&&!DISCORD_POST_WEBHOOK_URL.includes("ì—¬ê¸°ì—")&&fetch(`${DISCORD_POST_WEBHOOK_URL}/messages/${e.discordMessageId}`,{method:"DELETE"}).catch(t=>{console.error("Discord Delete Error:",t),logAuditEvent("discord_delete_error",{postId:e?.id||null,discordMessageId:e?.discordMessageId||null,error:String(t)}),sendLogToDiscord(["âš ï¸ **ë””ìŠ¤ì½”ë“œ ë“±ë¡ ì•Œë¦¼ ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨**","",`- **postId**: ${e?.id||""}`,`- **discordMessageId**: ${e?.discordMessageId||""}`,`- **error**: ${String(t)}`])})}function updateDiscordMessage(e,t,n){if(!e?.discordMessageId||DISCORD_POST_WEBHOOK_URL.includes("ì—¬ê¸°ì—"))return;const a=buildDiscordPayload({...e,title:t,content:n});fetch(`${DISCORD_POST_WEBHOOK_URL}/messages/${e.discordMessageId}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).catch(t=>{console.error("Discord Update Error:",t),logAuditEvent("discord_update_error",{postId:e?.id||null,discordMessageId:e?.discordMessageId||null,error:String(t)}),sendLogToDiscord(["âš ï¸ **ë””ìŠ¤ì½”ë“œ ë“±ë¡ ì•Œë¦¼ ë©”ì‹œì§€ ìˆ˜ì • ì‹¤íŒ¨**","",`- **postId**: ${e?.id||""}`,`- **discordMessageId**: ${e?.discordMessageId||""}`,`- **error**: ${String(t)}`])})}async function saveManagedPostEdits(){if(!currentEditingPostId)return;const e=posts.find(e=>e.id===currentEditingPostId);if(!e)return;const t=String(elements.managePostTitle?.value||"").trim(),n=String(elements.managePostContent?.value||"").trim();if(!t||!n)return void alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");if(!unlockedPostIds.has(e.id)&&!canManagePost(e)){if(!e.password)return void alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");if(prompt("ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:")!==e.password)return void alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");unlockedPostIds.add(e.id)}try{await db.collection("posts").doc(e.id).update({title:t,content:n}),e.discordMessageId&&updateDiscordMessage(e,t,n),showToast('<i class="fa-solid fa-pen"></i> ìˆ˜ì • ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')}catch(e){console.error(e),alert("ìˆ˜ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}function checkExpiredPosts(){if(!db)return;const e=Date.now();let t=0;posts.forEach(n=>{if("notice"===n.type)return;if(n.deletedAt)return;if("full"===n.status)return;if(0===n.expirationTime)return;const a=n.expirationTime||CONSTANTS.DEFAULT_EXPIRATION_MS,s=new Date(n.createdAt).getTime();e-s>a&&(softDeletePostById(n.id,"expired","ìœ íš¨ê¸°ê°„ ë§Œë£Œë¡œ ìë™ ì‚­ì œ","auto_expire").then(()=>{deleteDiscordMessage(n),db.collection("posts").doc(n.id).update({discordMessageId:null}).catch(()=>{}),notifyDeletionToDiscord({...n,id:n.id},"expired","ìœ íš¨ê¸°ê°„ ë§Œë£Œë¡œ ìë™ ì‚­ì œ")}).catch(e=>{console.error("ë§Œë£Œ ì‚­ì œ ì˜¤ë¥˜:",e),logAuditEvent("expire_soft_delete_error",{postId:n?.id||null,error:String(e)})}),t++)}),t>0&&showToast(`<i class="fa-solid fa-clock-rotate-left"></i> ìœ íš¨ê¸°ê°„ì´ ì§€ë‚œ ê²Œì‹œê¸€ ${t}ê°œê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`)}function showToast(e,t=4e3){const n=elements.toastContainer;if(!n)return;const a=document.createElement("div");a.className="toast",a.innerHTML=e,n.appendChild(a),setTimeout(()=>{a.style.animation="toastFadeOut 0.3s forwards",a.addEventListener("animationend",()=>{a.remove()})},t)}function getDiscordRedirectUri(){return`${location.origin}${location.pathname}`}function base64UrlEncodeArrayBuffer(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}async function sha256Base64Url(e){const t=(new TextEncoder).encode(e);return base64UrlEncodeArrayBuffer(await crypto.subtle.digest("SHA-256",t))}function randomString(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",n=new Uint8Array(e);crypto.getRandomValues(n);let a="";for(let e=0;e<n.length;e++)a+=t[n[e]%66];return a}async function beginDiscordAdminVerify(){if(!currentUser)return void showToast("ë‹‰ë„¤ì„ ë¡œê·¸ì¸ í›„ ì–´ë“œë¯¼ ì¸ì¦ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.");if("file:"===location.protocol)return void alert("ë¡œì»¬ íŒŒì¼(file://)ë¡œ ì—´ë©´ Discord redirect_uriê°€ file://ë¡œ ì¡í˜€ ì¸ì¦ì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.\n\n- GitHub Pages ì£¼ì†Œë¡œ ì ‘ì†í•´ì„œ ì‹œë„í•˜ê±°ë‚˜\n- ë¡œì»¬ ì„œë²„(http://localhost)ë¡œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.");if(!DISCORD_ADMIN.clientId||DISCORD_ADMIN.clientId.includes("PUT_DISCORD_OAUTH_CLIENT_ID_HERE"))return void alert("DISCORD_ADMIN.clientId ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. Discord ê°œë°œì í¬í„¸ì—ì„œ OAuth2 Client IDë¥¼ ë„£ì–´ì£¼ì„¸ìš”.");const e=randomString(32),t=randomString(64),n=await sha256Base64Url(t);sessionStorage.setItem("discord_admin_state",e),sessionStorage.setItem("discord_admin_verifier",t);const a=new URLSearchParams({client_id:DISCORD_ADMIN.clientId,redirect_uri:getDiscordRedirectUri(),response_type:"code",scope:DISCORD_ADMIN.scopes.join(" "),state:e,code_challenge:n,code_challenge_method:"S256"});location.href=`https://discord.com/oauth2/authorize?${a.toString()}`}async function handleDiscordAdminCallback(){const e=new URL(location.href),t=e.searchParams.get("code"),n=e.searchParams.get("state"),a=e.searchParams.get("error");if(!t&&!a)return;if(e.searchParams.delete("code"),e.searchParams.delete("state"),e.searchParams.delete("error"),e.searchParams.delete("error_description"),history.replaceState({},document.title,e.toString()),a)return void showToast("ë””ìŠ¤ì½”ë“œ ì¸ì¦ì´ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");if(!currentUser)return void showToast("ë‹‰ë„¤ì„ ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì–´ë“œë¯¼ ì¸ì¦ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.");const s=sessionStorage.getItem("discord_admin_state"),r=sessionStorage.getItem("discord_admin_verifier");if(sessionStorage.removeItem("discord_admin_state"),sessionStorage.removeItem("discord_admin_verifier"),s&&r&&n&&s===n)try{const e=await verifyDiscordAdminViaWorker({code:t,codeVerifier:r,redirectUri:getDiscordRedirectUri()});if(!e?.ok)return void showToast(e?.message||"ì–´ë“œë¯¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");currentUser.isAdmin=!0,currentUser.adminAuth={provider:"discord",discordUserId:e.discordUser?.id||"",discordUsername:e.discordUser?.username||"",verifiedAt:(new Date).toISOString(),guildId:DISCORD_ADMIN.guildId,roleId:DISCORD_ADMIN.roleId},await refreshCurrentUserCharacter(),localStorage.setItem("rudra_user",JSON.stringify(currentUser)),updateUserUI(),showToast("ì–´ë“œë¯¼ ì¸ì¦ ì™„ë£Œ!")}catch(e){console.error(e),showToast("ë””ìŠ¤ì½”ë“œ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.")}else showToast("ë””ìŠ¤ì½”ë“œ ì¸ì¦ ìƒíƒœê°’ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.")}async function refreshCurrentUserCharacter(){try{if(!currentUser?.name)return;const e=await fetchCharacterData(currentUser.name);if(!e)return;const t=currentUser.dps||0;currentUser={...currentUser,name:e.name,class:e.class,level:e.level,itemLevel:e.item_level,avatar:e.profile_img,charKey:e.charKey||null,verified:!0,dps:t}}catch(e){console.error("ìºë¦­í„° ì •ë³´ ê°±ì‹  ì‹¤íŒ¨:",e)}}async function verifyDiscordAdminViaWorker(e){if(!DISCORD_ADMIN.verifyEndpoint||DISCORD_ADMIN.verifyEndpoint.includes("PUT_CLOUDFLARE_WORKER_VERIFY_URL_HERE"))throw new Error("DISCORD_ADMIN.verifyEndpoint ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.");const t=await fetch(DISCORD_ADMIN.verifyEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e.code,codeVerifier:e.codeVerifier,redirectUri:e.redirectUri,guildId:DISCORD_ADMIN.guildId,roleId:DISCORD_ADMIN.roleId})}),n=await t.json().catch(()=>({}));if(!t.ok)throw new Error(n?.message||`verify failed: ${t.status}`);return n}function renderNotices(e=!1){const t=elements.noticeList;if(!t)return;const n=posts.filter(e=>"notice"===e.type&&!e.deletedAt).sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt));if(0===n.length)return t.innerHTML='<div class="notice-empty">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>',void elements.loadMoreNoticeBtn.classList.add("hidden");const a=e?n:n.slice(0,CONSTANTS.NOTICE_LIMIT);!e&&n.length>CONSTANTS.NOTICE_LIMIT?elements.loadMoreNoticeBtn.classList.remove("hidden"):elements.loadMoreNoticeBtn.classList.add("hidden"),t.innerHTML="",a.forEach(e=>{const n=new Date(e.createdAt).toLocaleDateString(),a=document.createElement("div");if(a.className="notice-card",a.innerHTML=`\n            <div class="notice-header">\n                <span class="notice-badge">NOTICE</span>\n                <span class="notice-date">${n}</span>\n            </div>\n            <h4 class="notice-title">${e.title}</h4>\n            <p class="notice-content">${e.content}</p>\n            ${currentUser&&currentUser.isAdmin?`\n                <div style="margin-top:8px; text-align:right;">\n                    <button id="editNoticeBtn-${e.id}" class="btn-outline btn-small" style="font-size:0.7rem; padding:4px 8px;">ìˆ˜ì •</button>\n                    <button id="deleteNoticeBtn-${e.id}" class="btn-danger btn-small" style="font-size:0.7rem; padding:4px 8px; margin-left: 4px;">ì‚­ì œ</button>\n                </div>\n            `:""}\n        `,a.style.cursor="pointer",a.onclick=()=>showPostDetail(e.id),t.appendChild(a),currentUser&&currentUser.isAdmin){const t=document.getElementById(`editNoticeBtn-${e.id}`),n=document.getElementById(`deleteNoticeBtn-${e.id}`);t&&(t.onclick=t=>{t.stopPropagation(),openWriteModal(!0,e)}),n&&(n.onclick=t=>{t.stopPropagation(),deleteNotice(e)})}})}function deleteNotice(e){confirm("ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&softDeletePostById(e.id,"notice_deleted","ê´€ë¦¬ìì— ì˜í•´ ê³µì§€ì‚¬í•­ ì‚­ì œ","notice_delete_ui").then(()=>{showToast("ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),notifyDeletionToDiscord({...e,id:e.id},"notice_deleted","ê´€ë¦¬ìì— ì˜í•´ ê³µì§€ì‚¬í•­ ì‚­ì œ")}).catch(e=>{console.error("ê³µì§€ ì‚­ì œ ì‹¤íŒ¨:",e),alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")})}function renderPosts(){elements.postList.innerHTML="",posts.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),elements.writeBtn&&elements.writeBtn.classList.toggle("hidden","all"===currentTab);let e=posts.filter(e=>"notice"!==e.type&&(!e.deletedAt&&("completed"===currentTab?"full"===e.status:"all"===currentTab?"full"!==e.status&&("party"===e.type||"member"===e.type):"full"!==e.status&&e.type===currentTab)));const t=elements.roleFilter?elements.roleFilter.value:"all";"all"!==t&&(e=e.filter(e=>{const n=Array.isArray(e.roles)?e.roles:[];return!n.length||(!!n.includes("ë¬´ê´€")||(!("tank"!==t||!n.includes("ìˆ˜í˜¸ì„±")&&!n.includes("ê²€ì„±"))||(!("dps"!==t||!(n.includes("ì‚´ì„±")||n.includes("ê¶ì„±")||n.includes("ë§ˆë„ì„±")||n.includes("ì •ë ¹ì„±")))||!("healer"!==t||!n.includes("ì¹˜ìœ ì„±")&&!n.includes("í˜¸ë²•ì„±")))))}));const n=elements.categoryFilter?elements.categoryFilter.value:"all";"all"!==n&&(e=e.filter(e=>e.category===n)),0!==e.length?e.forEach(e=>{const t=new Date(e.createdAt).toLocaleDateString()+" "+new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),n=(Array.isArray(e.roles)?e.roles:[]).filter(Boolean).map(e=>`<span class="role-badge">${e}</span>`).join(" "),a="full"===e.status?'<span class="party-status status-full">ëª¨ì§‘ì™„ë£Œ</span>':'<span class="party-status status-recruiting">ëª¨ì§‘ì¤‘</span>',s=e.author||{name:"ì‘ì„±ì",class:"",dps:0,itemLevel:0,avatar:null,charKey:null},r=s.dps>0?`<span class="dps-tag">DPS ${s.dps.toLocaleString()}</span>`:"",o=(s.itemLevel||0).toLocaleString();let i="";e.category&&(i=`<span class="category-badge">[${e.category}] ${e.categoryDetail||""} ${e.difficulty?"("+e.difficulty+")":""}</span>`);const l=document.createElement("div");if(l.className=`post-card type-${e.type}`,"full"===e.status){l.className+=" status-full";let t="";e.members&&e.members.length>0?(e.members.slice(0,5).forEach(e=>{const n=avatarUrlFromCharKeyOrFallback(e.charKey,e.avatar,e.name);t+=`\n                        <img src="${n}" \n                             class="full-member-avatar" \n                             title="${e.name}" \n                             onclick="event.stopPropagation(); openAtulPage('${e.name}')"\n                             onerror="this.src=defaultAvatarDataUri('U')">\n                    `}),e.members.length>5&&(t+=`<div class="full-member-avatar" style="background:#333; color:#fff; display:flex; align-items:center; justify-content:center; font-size:0.8rem;">+${e.members.length-5}</div>`)):t='<span style="color:#666; font-size:0.9rem;">ë©¤ë²„ ì •ë³´ ì—†ìŒ</span>',l.innerHTML=`\n                <div class="full-overlay">\n                    <div class="full-text">ëª¨ì§‘ ì™„ë£Œ</div>\n                    <div class="full-members">${t}</div>\n                    <div style="color:#aaa; font-size:0.9rem; margin-top:10px;">${e.title}</div>\n                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°</div>\n                </div>\n                <div style="padding:10px; text-align:center;">\n                    <button onclick="event.stopPropagation(); checkPasswordAndManage('${e.id}')" class="btn-outline full-width">ê´€ë¦¬</button>\n                </div>\n            `}else{const c="all"===currentTab?"party"===e.type?'<span class="type-badge party"><i class="fa-solid fa-users"></i> íŒŒí‹°ì› êµ¬í•´ìš”</span>':'<span class="type-badge member"><i class="fa-solid fa-user-plus"></i> íŒŒí‹° êµ¬í•´ìš”</span>':"",d=s.class?`${s.class} `:"";l.innerHTML=`\n                <div class="post-header">\n                    <div class="badge-container">\n                        ${c}\n                        ${a}\n                        ${i}\n                        ${n}\n                    </div>\n                    <span class="post-time">${t}</span>\n                </div>\n                <h3 class="post-title">${e.title}</h3>\n                <p class="post-content">${e.content}</p>\n                \n                <div class="post-footer">\n                    <div class="author-info">\n                        <img src="${avatarUrlFromCharKeyOrFallback(s.charKey,s.avatar,s.name)}" class="author-avatar" onerror="this.src=defaultAvatarDataUri('U')">\n                        <div class="author-detail">\n                            <div class="author-name">${s.name}</div>\n                            <div class="author-meta">\n                                ${d}\n                                ${r}\n                                <span style="margin-left:4px;">(Lv.${o})</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div style="display:flex; gap:8px; margin-top:8px;">\n                    ${e.link?`<button onclick="event.stopPropagation(); window.open('${e.link}')" class="btn-primary full-width" style="padding: 8px;">ì°¸ì—¬</button>`:""}\n                    <button onclick="event.stopPropagation(); checkPasswordAndManage('${e.id}')" class="btn-outline full-width" style="padding: 8px;">ê´€ë¦¬</button>\n                </div>\n            `}l.onclick=()=>showPostDetail(e.id),elements.postList.appendChild(l)}):elements.postList.innerHTML='<div class="no-posts" style="text-align:center; padding:40px; color:#aaa; grid-column:1/-1;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}function showPostDetail(e){const t=posts.find(t=>t.id===e);if(!t)return;elements.detailModal.classList.remove("hidden"),"notice"===t.type?(elements.detailPartySection.classList.add("hidden"),elements.detailCategoryBadge.innerHTML='<span class="notice-badge" style="font-size:0.9rem;">NOTICE</span>'):(elements.detailPartySection.classList.remove("hidden"),t.category?elements.detailCategoryBadge.innerHTML=`<span class="category-badge" style="font-size:0.9rem;">[${t.category}] ${t.categoryDetail||""} ${t.difficulty?"("+t.difficulty+")":""}</span>`:elements.detailCategoryBadge.innerHTML="",renderDetailPartyList(t));const n=(Array.isArray(t.roles)?t.roles:[]).filter(Boolean);elements.detailRoles.innerHTML="notice"===t.type?"":n.map(e=>`<span class="role-badge">${e}</span>`).join(" ");const a=t.author||t.members&&t.members[0]||{name:"ì‘ì„±ì",class:"",itemLevel:0,avatar:null,charKey:null};elements.detailTitle.textContent=t.title,elements.detailAuthor.textContent=a.name||"ì‘ì„±ì",elements.detailTime.textContent=new Date(t.createdAt).toLocaleString(),elements.detailContent.textContent=t.content,t.link?(elements.detailLink.href=t.link,elements.detailLink.classList.remove("hidden")):elements.detailLink.classList.add("hidden");const s=document.getElementById("detailAuthorAvatar"),r=document.getElementById("detailAuthorName"),o=document.getElementById("detailAuthorClass"),i=document.getElementById("detailAuthorItemLevel");s&&(s.src=avatarUrlFromCharKeyOrFallback(a.charKey,a.avatar,a.name),s.onerror=()=>{s.src=defaultAvatarDataUri("U")}),r&&(r.textContent=a.name||"ì‘ì„±ì"),o&&(o.textContent=a.class||""),i&&(i.textContent=(a.itemLevel||0).toLocaleString());const l=document.getElementById("detailAuthorProfile");l&&(l.onclick=()=>openAtulPage(a.name))}function renderDetailPartyList(e){const t=elements.detailPartyListContainer;if(!t)return;const n=document.getElementById("detailAuthorAvatar"),a=document.getElementById("detailAuthorName"),s=document.getElementById("detailAuthorClass"),r=document.getElementById("detailAuthorItemLevel");if(e.author){n.src=avatarUrlFromCharKeyOrFallback(e.author.charKey,e.author.avatar,e.author.name),n.onerror=()=>{n.src=defaultAvatarDataUri("U")},a.textContent=e.author.name,s.textContent=e.author.class||"",r.textContent=(e.author.itemLevel||0).toLocaleString();document.getElementById("detailAuthorProfile").onclick=()=>openAtulPage(e.author.name)}let o=`<label style="display:block; margin-bottom:10px; color:#a1a1aa;">íŒŒí‹°ì› ëª©ë¡ (${e.members?e.members.length:0}/8)</label>`;o+='<div class="party-grid">',e.members&&e.members.length>0?e.members.forEach(e=>{const t=avatarUrlFromCharKeyOrFallback(e.charKey,e.avatar,e.name),n=e.dps>0?`DPS ${e.dps.toLocaleString()}`:"",a=e.itemLevel||0;o+=`\n                <div class="party-member-card" onclick="openAtulPage('${e.name}')">\n                    <img src="${t}" class="pm-avatar" onerror="this.src=defaultAvatarDataUri('U')">\n                    <div class="pm-name">${e.name}</div>\n                    <div class="pm-class">${e.class}</div>\n                    <div class="pm-dps" style="color:#a78bfa;">${n}</div>\n                    <div style="font-size:0.8rem; color:#666;">(Lv.${a.toLocaleString()})</div>\n                </div>\n            `}):o+='<div style="color:#666;">íŒŒí‹°ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>',o+="</div>",t.innerHTML=o}function openAtulPage(e){if(e){const t=`https://www.aion2tool.com/char/serverid=2002/${encodeURIComponent(e)}`;window.open(t,"_blank")}}function openManageModal(e){currentEditingPostId=e.id,elements.manageModal.classList.remove("hidden"),elements.managePostInfo.innerHTML=`<h4>${e.title}</h4>`,elements.managePostTitle&&(elements.managePostTitle.value=e.title||""),elements.managePostContent&&(elements.managePostContent.value=e.content||""),renderPartyMembers()}function updatePostStatus(e){if(!currentEditingPostId)return;const t=posts.find(e=>e.id===currentEditingPostId);if(t){if(!unlockedPostIds.has(t.id)&&!canManagePost(t)){if(!t.password)return void alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");if(prompt("ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:")!==t.password)return void alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");unlockedPostIds.add(t.id)}db.collection("posts").doc(t.id).update({status:e}).then(()=>{"full"===e&&"full"!==t.status&&(deleteDiscordMessage(t),db.collection("posts").doc(t.id).update({discordMessageId:null})),alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."),elements.manageModal.classList.add("hidden")})}}async function addPartyMember(){if(!currentEditingPostId)return;const e=posts.find(e=>e.id===currentEditingPostId);if(!e||!canManagePost(e))return void alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const t=elements.newMemberName.value.trim(),n=elements.newMemberClass.value;if(!t)return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");elements.addMemberBtn.textContent="ê²€ìƒ‰ì¤‘...";const a=await fetchCharacterData(t);if(elements.addMemberBtn.textContent="ì¶”ê°€",e){const s={name:t,class:n,isLeader:!1,dps:0,itemLevel:a?a.item_level:0,charKey:a&&a.charId||null,avatar:a?a.profile_img:null},r=e.members?[...e.members,s]:[s];db.collection("posts").doc(e.id).update({members:r}).then(()=>{elements.newMemberName.value=""})}}function renderPartyMembers(){if(!currentEditingPostId)return;const e=posts.find(e=>e.id===currentEditingPostId);elements.partyMemberList&&(elements.partyMemberList.innerHTML="",e&&e.members&&e.members.forEach((e,t)=>{const n=document.createElement("div");n.className="member-item",n.innerHTML=`\n            <div class="member-info">\n                ${e.isLeader?'<i class="fa-solid fa-crown" style="color:#ffd700;"></i>':""}\n                <b>${e.name}</b> (${e.class})\n            </div>\n            <button onclick="deletePartyMember(${t})" style="border:none; background:none; color:red; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>\n        `,elements.partyMemberList.appendChild(n)}))}function deletePost(){if(currentEditingPostId&&confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){const e=posts.find(e=>e.id===currentEditingPostId),t=!!e&&unlockedPostIds.has(e.id);if(e&&!t&&!canManagePost(e)){if(!e.password)return void alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");if(prompt("ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:")!==e.password)return void alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");unlockedPostIds.add(e.id)}softDeletePostById(currentEditingPostId,"manual_delete","ì‘ì„±ì/ê´€ë¦¬ì ìˆ˜ë™ ì‚­ì œ","post_delete_ui").then(()=>{e&&deleteDiscordMessage(e),e&&db.collection("posts").doc(e.id).update({discordMessageId:null}).catch(()=>{}),elements.manageModal.classList.add("hidden"),currentEditingPostId=null,showToast("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),notifyDeletionToDiscord({...e||{},id:currentEditingPostId},"manual_delete","ì‘ì„±ì/ê´€ë¦¬ì ìˆ˜ë™ ì‚­ì œ")}).catch(e=>{console.error("ì‚­ì œ ì‹¤íŒ¨",e),alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")})}}async function fetchCharacterData(e){try{lastCharacterFetchError=null;const t=`https://api.aon2.info/api/v1/aion2/rankings/item-level/search?characterName=${encodeURIComponent(e)}&serverId=2002`,n=[`${t}&raceId=2`,`${t}&raceId=1`,`${t}`];let a=null,s="";for(const e of n){const t=await fetch(e),n=await t.text().catch(()=>"");if(t.ok){try{a=JSON.parse(n)}catch{a=null}if(a)break}else s=n}if(!a){if(s)try{const e=JSON.parse(s);e?.message&&(lastCharacterFetchError=String(e.message))}catch{}return lastCharacterFetchError||(lastCharacterFetchError="API í˜¸ì¶œì´ ë§‰í˜”ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (CORS/í”„ë¡ì‹œ í•„ìš”)"),null}const r=await decodeAon2PayloadIfNeeded(a);if(!r)return null;const o=r?.data??r,i=Array.isArray(o)?o:o&&"object"==typeof o&&!Array.isArray(o)?Object.values(o):null,l=Array.isArray(o?.characters)?o.characters:null;let c=o?.character||r?.character||(l?l[0]:null)||null;if(!c&&i){const t=String(e||"").trim().toLowerCase();c=i.find(e=>String(e?.characterName||e?.name||"").trim().toLowerCase()===t)||i[0]||null}if(!c){const e=Object.keys(a||{}).slice(0,10).join(", "),t=Object.keys(a?.data||{}).slice(0,10).join(", ");return lastCharacterFetchError=`ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤(ë˜ëŠ” API ì‘ë‹µ êµ¬ì¡° ë³€ê²½).\nkeys: [${e}] / data: [${t}]`,null}const d=extractCharKey(c),m=c.characterId||c.charId||c.id||c.character_id||c?.character?.characterId||null;if(!m&&!d)return null;const u=`https://api.aon2.info/api/v1/aion2/characters/detail?serverId=2002&characterId=${encodeURIComponent(m)}`,p=await fetch(u);if(!p.ok){const e=await p.text().catch(()=>"");throw console.warn("character detail failed:",p.status,e.slice(0,200)),new Error(`detail http ${p.status}`)}let g=await p.json().catch(()=>null);const h=await decodeAon2PayloadIfNeeded(g);if(!h)return null;const f=h?.data??h;if(!f)return null;let y=0;y=f.combatScore?f.combatScore:f.combatPoint?f.combatPoint:f.stats&&f.stats.combatPower?f.stats.combatPower:f.totalItemLevel;const v=normalizeScoreInfoStats(f),E=extractWeaponMinMaxFromItemDetails(f),b=v?{...v,...E,skillDamage:0}:null;return{name:f.characterName,level:f.level,class:f.classInfo?f.classInfo.className:"ì•Œ ìˆ˜ ì—†ìŒ",item_level:f.totalItemLevel,dps:y,profile_img:f.profileImageUrl,server:"ì§€ì¼ˆ",charId:m,charKey:d,aonScore:f.aonScore||0,combatScore:f.combatScore||0,calcStats:b}}catch(e){return console.error(e),lastCharacterFetchError=String(e?.message?e.message:e),null}}window.checkPasswordAndManage=function(e){const t=posts.find(t=>t.id===e);if(t){if(currentUser?.isAdmin)return unlockedPostIds.add(e),void openManageModal(t);if(currentUser&&canManagePost(t))return unlockedPostIds.add(e),void openManageModal(t);if(t.password){return void(prompt("ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:")===t.password?(unlockedPostIds.add(e),openManageModal(t)):alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."))}alert("ì‘ì„±ì ë³¸ì¸ë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")}},window.deletePartyMember=function(e){if(!currentEditingPostId)return;const t=posts.find(e=>e.id===currentEditingPostId);if(t&&t.members){if(!canManagePost(t))return void alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){const n=[...t.members];n.splice(e,1),db.collection("posts").doc(t.id).update({members:n})}}};